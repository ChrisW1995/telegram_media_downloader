<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Telegram Media Downloader</title>
  <link href="{{ url_for('static', filename='layui/css/layui.css') }}" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/index.css') }}" rel="stylesheet">
  <style>
    body {
      padding: 6px 16px;
    }
  </style>
</head>

<body>
  <div class="layui-tab" lay-filter="telegram_media_downloader">
    <div class="header-title layui-tab-brief">
      <ul class="layui-tab-title">
        <li class="layui-this">ä¸‹è¼‰ç®¡ç†</li>
        <li>ç¾¤çµ„ç®¡ç†</li>
      </ul>
      <div class="stop-btn" id="download_control" onclick="toggleDownloadState()" style="display: none;">
        <span id="download_control_text">æš«åœä¸‹è¼‰</span>
      </div>
    </div>
    <div class="layui-tab-content" style="padding: 0;">
      <!-- ä¸‹è¼‰ç®¡ç†åˆ†é  -->
      <div class="layui-tab-item layui-show">
        <div style="padding: 20px;">
          <div class="layui-card">
            <div class="layui-card-header">
              ä¸‹è¼‰æ§åˆ¶
              <div style="float: right;">
                <button class="layui-btn layui-btn-normal" onclick="startAllDownloads()">
                  <i class="layui-icon layui-icon-play"></i> å•Ÿå‹•é¸ä¸­é …ç›®
                </button>
              </div>
            </div>
            <div class="layui-card-body">
              <div class="layui-text">é¸æ“‡è¦ä¸‹è¼‰çš„é …ç›®ï¼Œç„¶å¾Œé»æ“Šã€Œå•Ÿå‹•é¸ä¸­é …ç›®ã€ä¾†é–‹å§‹ä¸‹è¼‰</div>
              
              <!-- ä¸‹è¼‰é€²åº¦é¡¯ç¤ºå€åŸŸ -->
              <div id="download-progress-area" style="margin-top: 15px; display: none;">
                <!-- ä»»å‹™ç¸½é€²åº¦ -->
                <div style="margin-bottom: 10px;">
                  <div style="font-size: 14px; font-weight: bold; margin-bottom: 5px;">
                    ç¸½é€²åº¦ - <span id="task-status-text">æº–å‚™é–‹å§‹ä¸‹è¼‰...</span>
                  </div>
                  <div class="layui-progress layui-progress-big" lay-showpercent="true" lay-filter="task-progress-bar">
                    <div class="layui-progress-bar layui-bg-blue" lay-percent="0%"></div>
                  </div>
                  <div style="font-size: 12px; color: #999; margin-top: 5px;">
                    å·²å®Œæˆ <span id="task-completed">0</span> / <span id="task-total">0</span> å€‹ä»»å‹™
                    <span style="margin-left: 15px; color: #5FB878;">
                      <i class="layui-icon layui-icon-download-circle"></i>
                      <span id="total-download-speed">0.00 B/s</span>
                    </span>
                  </div>
                </div>
                
                <!-- ä¸¦ç™¼æ–‡ä»¶é€²åº¦ -->
                <div id="concurrent-progress-section" style="display: none; margin-top: 20px;">
                  <div style="font-size: 14px; font-weight: bold; margin-bottom: 10px;">
                    ä¸¦ç™¼ä¸‹è¼‰é€²åº¦ (<span id="concurrent-count">0</span> å€‹æª”æ¡ˆåŒæ™‚ä¸‹è¼‰)
                  </div>
                  <div id="concurrent-progress-container">
                    <!-- ä¸¦ç™¼é€²åº¦æ¢æœƒå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="layui-card" style="margin-top: 20px;">
            <div class="layui-card-header">æ‰¹é‡æ–°å¢ä¸‹è¼‰ ID</div>
            <div class="layui-card-body">
              <form class="layui-form" lay-filter="custom-download-form">
                <div class="layui-form-item">
                  <label class="layui-form-label">é¸æ“‡ç¾¤çµ„</label>
                  <div class="layui-input-block">
                    <select name="chat_id" lay-verify="required" lay-search="">
                      <option value="">è«‹é¸æ“‡ç¾¤çµ„</option>
                    </select>
                  </div>
                </div>
                <div class="layui-form-item layui-form-text">
                  <label class="layui-form-label">è¨Šæ¯ ID</label>
                  <div class="layui-input-block">
                    <textarea name="message_ids" placeholder="è«‹è¼¸å…¥è¨Šæ¯IDï¼Œæ”¯æ´ä»¥ä¸‹æ ¼å¼ï¼š&#10;å–®å€‹IDï¼š123&#10;å¤šå€‹IDï¼š123,456,789&#10;ç¯„åœï¼š123-130&#10;æ··åˆï¼š123,456-460,789" class="layui-textarea" style="height: 120px;"></textarea>
                  </div>
                </div>
                <div class="layui-form-item">
                  <div class="layui-input-block">
                    <button class="layui-btn" lay-submit="" lay-filter="submit-download">ç«‹å³ä¸‹è¼‰</button>
                    <button type="reset" class="layui-btn layui-btn-primary">é‡ç½®</button>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <div class="layui-card" style="margin-top: 20px;">
            <div class="layui-card-header">
              ä¸‹è¼‰æ­·å²
              <div style="float: right;">
                <button class="layui-btn layui-btn-sm" onclick="selectAllTasks()">å…¨é¸</button>
                <button class="layui-btn layui-btn-sm layui-btn-normal" onclick="selectPendingTasks()">é¸æ“‡å¾…ä¸‹è¼‰</button>
                <button class="layui-btn layui-btn-sm" onclick="deselectAllTasks()">å–æ¶ˆå…¨é¸</button>
                <button class="layui-btn layui-btn-sm layui-btn-warm" onclick="cleanDownloadedItems()">æ¸…ç†å·²ä¸‹è¼‰</button>
                <button class="layui-btn layui-btn-sm layui-btn-danger" onclick="removeSelectedTasks()">ç§»é™¤é¸ä¸­</button>
              </div>
            </div>
            <div class="layui-card-body">
              <!-- ç¯©é¸å€åŸŸ -->
              <div style="margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; box-shadow: 0 4px 15px 0 rgba(102, 126, 234, 0.3);">
                <div class="layui-row layui-col-space15">
                  <!-- ç¯©é¸æ¨™é¡Œ -->
                  <div class="layui-col-md12" style="margin-bottom: 15px;">
                    <h3 style="color: white; margin: 0; font-size: 16px; font-weight: 500;">
                      <i class="layui-icon layui-icon-search" style="margin-right: 8px;"></i>
                      æ™ºèƒ½ç¯©é¸æ§åˆ¶å°
                    </h3>
                  </div>
                  
                  <!-- ç¯©é¸æ§åˆ¶é … -->
                  <div class="layui-col-md4">
                    <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); border-radius: 6px; padding: 12px;">
                      <label style="color: rgba(255,255,255,0.9); font-size: 13px; margin-bottom: 8px; display: block;">
                        <i class="layui-icon layui-icon-group"></i> ç¾¤çµ„ç¯©é¸
                      </label>
                      <select id="group-filter" lay-filter="group-filter" style="width: 100%; border-radius: 4px; border: 1px solid rgba(255,255,255,0.3);">
                        <option value="">ğŸ” å…¨éƒ¨ç¾¤çµ„</option>
                      </select>
                    </div>
                  </div>
                  
                  <div class="layui-col-md4">
                    <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); border-radius: 6px; padding: 12px;">
                      <label style="color: rgba(255,255,255,0.9); font-size: 13px; margin-bottom: 8px; display: block;">
                        <i class="layui-icon layui-icon-flag"></i> ç‹€æ…‹ç¯©é¸
                      </label>
                      <select id="status-filter" lay-filter="status-filter" style="width: 100%; border-radius: 4px; border: 1px solid rgba(255,255,255,0.3);">
                        <option value="">ğŸ“Š å…¨éƒ¨ç‹€æ…‹</option>
                        <option value="pending">â³ å¾…ä¸‹è¼‰</option>
                        <option value="downloading">âš¡ ä¸‹è¼‰ä¸­</option>
                        <option value="downloaded">âœ… å·²ä¸‹è¼‰</option>
                        <option value="failed">âŒ å¤±æ•—</option>
                      </select>
                    </div>
                  </div>
                  
                  <div class="layui-col-md4">
                    <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); border-radius: 6px; padding: 12px;">
                      <label style="color: rgba(255,255,255,0.9); font-size: 13px; margin-bottom: 8px; display: block;">
                        <i class="layui-icon layui-icon-util"></i> æ“ä½œ
                      </label>
                      <div class="layui-btn-group" style="width: 100%;">
                        <button class="layui-btn layui-btn-normal" onclick="applyFilters()" style="border-radius: 4px 0 0 4px; width: 50%; background: rgba(22, 155, 213, 0.8); border: none;">
                          <i class="layui-icon layui-icon-search"></i> ç¯©é¸
                        </button>
                        <button class="layui-btn" onclick="clearFilters()" style="border-radius: 0 4px 4px 0; width: 50%; background: rgba(255,255,255,0.2); border: none; color: white;">
                          <i class="layui-icon layui-icon-refresh-1"></i> æ¸…é™¤
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- çµ±è¨ˆä¿¡æ¯ -->
                <div style="margin-top: 15px; text-align: center; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);">
                  <span id="filtered-count" style="
                    color: white; 
                    font-size: 14px; 
                    background: rgba(255,255,255,0.2); 
                    padding: 6px 16px; 
                    border-radius: 15px; 
                    backdrop-filter: blur(5px);
                  ">
                    ğŸ“‹ é¡¯ç¤ºï¼š0 é …ç›®
                  </span>
                </div>
              </div>
              <table class="layui-table" id="download-history-table">
                <thead>
                  <tr>
                    <th width="50">
                      <input type="checkbox" id="select-all-checkbox" lay-skin="primary" title="">
                    </th>
                    <th>æ™‚é–“</th>
                    <th>ç¾¤çµ„</th>
                    <th>è¨Šæ¯ID</th>
                    <th>ç‹€æ…‹</th>
                    <th>æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="download-history-tbody">
                  <tr>
                    <td colspan="6" style="text-align: center;">æš«ç„¡ä¸‹è¼‰æ­·å²</td>
                  </tr>
                </tbody>
              </table>
              
              <!-- åˆ†é å°èˆª -->
              <div id="history-pagination" style="margin-top: 15px; display: none;"></div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- ç¾¤çµ„ç®¡ç†åˆ†é  -->
      <div class="layui-tab-item">
        <div style="padding: 20px;">
          <div class="layui-card">
            <div class="layui-card-header">
              ç¾¤çµ„ç®¡ç†
              <div style="float: right;">
                <button class="layui-btn layui-btn-sm layui-btn-normal" onclick="addGroupDialog()">
                  <i class="layui-icon layui-icon-add-circle"></i> æ–°å¢ç¾¤çµ„
                </button>
                <button class="layui-btn layui-btn-sm" onclick="loadGroups()">
                  <i class="layui-icon layui-icon-refresh"></i> é‡æ–°æ•´ç†
                </button>
                <button class="layui-btn layui-btn-sm layui-btn-warm" onclick="importGroupFromLink()">
                  <i class="layui-icon layui-icon-link"></i> å¾é€£çµåŒ¯å…¥
                </button>
              </div>
            </div>
            <div class="layui-card-body">
              <div class="layui-row layui-col-space15">
                <div class="layui-col-md12">
                  <!-- å¿«é€Ÿæœç´¢ -->
                  <div style="margin-bottom: 15px;">
                    <div class="layui-inline">
                      <input type="text" id="group-search" placeholder="æœå°‹ç¾¤çµ„åç¨±æˆ–Chat ID" autocomplete="off" class="layui-input" style="width: 200px;">
                    </div>
                    <div class="layui-inline">
                      <button class="layui-btn layui-btn-sm" onclick="searchGroups()">
                        <i class="layui-icon layui-icon-search"></i> æœå°‹
                      </button>
                    </div>
                    <div class="layui-inline" style="float: right;">
                      <label class="layui-checkbox-button">
                        <input type="checkbox" id="select-all-groups" lay-skin="primary">
                        å…¨é¸
                      </label>
                    </div>
                  </div>
                  
                  <table class="layui-table" id="groups-table">
                    <thead>
                      <tr>
                        <th width="40">é¸æ“‡</th>
                        <th>ç¾¤çµ„åç¨±</th>
                        <th width="150">Chat ID</th>
                        <th width="100">å¾…ä¸‹è¼‰æ•¸é‡</th>
                        <th width="100">ç‹€æ…‹</th>
                        <th width="80">é¡å‹</th>
                        <th width="250">æ“ä½œ</th>
                      </tr>
                    </thead>
                    <tbody id="groups-tbody">
                      <tr>
                        <td colspan="7" style="text-align: center; color: #999; padding: 40px;">
                          <i class="layui-icon layui-icon-loading layui-icon-anim-rotate"></i> è¼‰å…¥ä¸­...
                        </td>
                      </tr>
                    </tbody>
                  </table>
                  
                  <!-- æ‰¹é‡æ“ä½œå€åŸŸ -->
                  <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e6e6e6;">
                    <div class="layui-btn-group">
                      <button class="layui-btn layui-btn-danger layui-btn-sm" onclick="deleteSelectedGroups()">
                        <i class="layui-icon layui-icon-delete"></i> åˆªé™¤é¸ä¸­
                      </button>
                      <button class="layui-btn layui-btn-warm layui-btn-sm" onclick="clearSelectedGroups()">
                        <i class="layui-icon layui-icon-close"></i> æ¸…ç©ºé¸ä¸­è¨Šæ¯
                      </button>
                      <button class="layui-btn layui-btn-sm" onclick="exportSelectedGroups()">
                        <i class="layui-icon layui-icon-export"></i> åŒ¯å‡ºé¸ä¸­
                      </button>
                    </div>
                    <div style="float: right;">
                      <span class="layui-badge" id="selected-count">å·²é¸æ“‡ï¼š0 å€‹ç¾¤çµ„</span>
                      <span class="layui-badge layui-bg-blue" id="total-groups">ç¸½å…±ï¼š0 å€‹ç¾¤çµ„</span>
                    </div>
                  </div>
                  
                  <!-- çµ±è¨ˆè³‡è¨Š -->
                  <div style="margin-top: 20px;">
                    <div class="layui-card">
                      <div class="layui-card-header">ç¾¤çµ„çµ±è¨ˆ</div>
                      <div class="layui-card-body">
                        <div class="layui-row layui-col-space15">
                          <div class="layui-col-md3">
                            <div style="text-align: center; padding: 20px;">
                              <div style="font-size: 24px; font-weight: bold; color: #009688;" id="stats-total-groups">0</div>
                              <div style="color: #666;">ç¸½ç¾¤çµ„æ•¸</div>
                            </div>
                          </div>
                          <div class="layui-col-md3">
                            <div style="text-align: center; padding: 20px;">
                              <div style="font-size: 24px; font-weight: bold; color: #FF5722;" id="stats-pending-messages">0</div>
                              <div style="color: #666;">å¾…ä¸‹è¼‰è¨Šæ¯</div>
                            </div>
                          </div>
                          <div class="layui-col-md3">
                            <div style="text-align: center; padding: 20px;">
                              <div style="font-size: 24px; font-weight: bold; color: #2196F3;" id="stats-active-groups">0</div>
                              <div style="color: #666;">æ´»èºç¾¤çµ„</div>
                            </div>
                          </div>
                          <div class="layui-col-md3">
                            <div style="text-align: center; padding: 20px;">
                              <div style="font-size: 24px; font-weight: bold; color: #4CAF50;" id="stats-empty-groups">0</div>
                              <div style="color: #666;">ç©ºç¾¤çµ„</div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="layui-footer">
    <div class="layui-row layui-col-space1">
      <div class="layui-col-md2">
        <p>Telegram Media Downloader V <b id="app_version" style="color: #009688;">undefined</b>
      </div>
      <div class="layui-col-md7">
      </div>
      <div class="layui-col-md3">
        <div style="padding: 5px; float: right;">
          <!-- <i class="layui-icon layui-icon-upload-circle" style="font-size: 16px; color: #1E9FFF; font-weight: 700;">
            <i id="upload_speed_title" style="color: black;"> 0.00 B/s </i>
          </i> -->

          <i class="layui-icon layui-icon-download-circle"
            style="font-size: 16px; color: #5FB878; font-weight: 700; margin-left: 15px;">
            <i id="download_speed_title" style="color: black;"> 0.00 B/s </i>
          </i>

        </div>
      </div>
    </div>
  </div>

  <script src="../static/layui/layui.js"></script>
  <script>

    var layer, $; // å…¨å±€è®Šé‡
    
    layui.use(['table', 'element', 'laypage'], function () {
      var table = layui.table;
      var element = layui.element;
      layer = layui.layer; // è¨­ç½®ç‚ºå…¨å±€
      var laypage = layui.laypage;
      $ = layui.$; // è¨­ç½®ç‚ºå…¨å±€
      var already_download_list_data = new Array()
      var download_list_table_data = new Array()

      $.ajax({
        url: "get_app_version"
        , type: "get"
        , async: false
        , dataType: "text"
        , success: function (result) {
          $("#app_version").html(result)
        }
      });

      download_state_change = function(e) {
        $.ajax({
        url: "set_download_state?state=" + e.dataset.value
        , type: "post"
        , async: false
        , dataType: "text"
        , success: function (result) {
          $("#download_state").html(result)
          e.dataset.value=result
        }
      });
    }

      tableIns = table.render({
        elem: '#download_list'
        , data: download_list_table_data
        , title: 'download_list'
        , height: 'full-160'
        , limit: 10000
        , cols: [[
          { field: 'chat', title: 'chat', width: 100 },
          { field: 'id', title: 'id', width: 100 }
          , { field: 'filename', title: 'file name', align: 'center' }
          , { field: 'total_size', title: 'total byte', align: 'center' }
          , {
            field: 'download_progress', title: 'download progress', align: 'center', templet: function (d) {
              var ys = '';
              if (30 < d.download_progress && d.download_progress < 100) {
                ys = 'layui-bg-blue'
              } else if (0 < d.download_progress && d.download_progress <= 30) {
                ys = 'layui-bg-red'
              }
              else if (100 == d.download_progress) {
                ys = 'layui-bg-green'
              }
              return '<div class="layui-progress layui-progress-big" lay-showpercent="true"  lay-filter="down-' + d.id + '"><div class="layui-progress-bar ' + ys + '" lay-percent="' + d.download_progress + '%"></div></div>'
            }
          }
          , { field: 'download_speed', title: 'download speed', align: 'center' }
        ]]
        , done: function (res, currentCount) {
          element.render()
        }
      });

      table.render({
        elem: '#already_download_list'
        , data: already_download_list_data
        , title: 'already_download_list'
        , height: 'full-160'
        , limit: 10000
        , cols: [[

          { field: 'id', title: 'id', width: 100 }
          , { field: 'filename', title: 'file name', align: 'center' }
          , { field: 'total_size', title: 'total size', align: 'center' }
          , { field: 'save_path', title: 'save path', align: 'center' }
        ]], done: function (res, currentCount) {
          element.render()
        }
      });

      function update_download_list() {
        $.ajax({
          url: "get_download_list?already_down=false"
          , type: "get"
          , async: false
          , dataType: "json"
          , success: function (result) {
            // first remove finish and update
            for (var j = 0, len2 = download_list_table_data.length; j < len2; j++) {
              find_iter = false
              for (var i = 0, len = result.length; i < len; i++) {
                if (result[i].chat == download_list_table_data[j].chat && result[i].id == download_list_table_data[j].id) {
                  download_list_table_data[j].download_progress = result[i].download_progress
                  var progress = download_list_table_data[j].download_progress
                  element.progress('down-' + result[i].chat + '-' + result[i].id, progress + '%');

                  var download_speed_obj = $('div[lay-filter="down_speed-' + result[i].chat + '-' + result[i].id + '"]')
                  download_speed_obj.html(result[i].download_speed)

                  if (progress == 100) {
                    var device_obj = $('div[lay-filter="down-' + result[i].chat + '-' + result[i].id + '"] div')
                    device_obj.removeClass("layui-bg-blue")
                    device_obj.addClass("layui-bg-green")
                    obj = $('div[lay-id="download_list"]  tr[data-index="' + result[i].chat + '-' + result[i].id + '"]')
                    obj.remove()
                  }
                  find_iter = true
                  break
                }
              }

            }

            // new task
            for (var i = 0, len = result.length; i < len; i++) {
              find_iter = false
              for (var j = 0, len2 = download_list_table_data.length; j < len2; j++) {
                if (result[i].chat == download_list_table_data[j].chat && result[i].id == download_list_table_data[j].id) {
                  find_iter = true
                  break
                }
              }

              if (find_iter || result[i].download_progress == 100) {
                continue;
              }
              // not found
              obj = $('div[lay-id="download_list"]  .layui-table-body .layui-table tbody')
              var tr = ' <tr data-index="' + result[i].chat + '-' + result[i].id + '">' +
                '<td data-field="id" data-key="1-0-0" class=""><div class="layui-table-cell laytable-cell-1-0-0">' + result[i].chat + '</div></td>' +
                '<td data-field="id" data-key="1-0-1" class=""><div class="layui-table-cell laytable-cell-1-0-1">' + result[i].id + '</div></td>' +
                '<td data-field="filename" data-key="1-0-2" class=""><div class="layui-table-cell laytable-cell-1-0-2" align="center">' + result[i].filename + '</div></td>' +
                '<td data-field="total_size" data-key="1-0-3" class=""><div class="layui-table-cell laytable-cell-1-0-3" align="center">' + result[i].total_size + '</div></td>' +
                '<td data-field="download_progress" data-key="1-0-4" data-content="' + result[i].download_progress + '" class=""><div class="layui-table-cell laytable-cell-1-0-4" align="center"><div class="layui-progress layui-progress-big" lay-showpercent="true" lay-filter="down-' + result[i].chat + '-' + result[i].id + '"><div class="layui-progress-bar layui-bg-blue" lay-percent="' + result[i].download_progress + '%" style="width: ' + result[i].download_progress + '%;"><span class="layui-progress-text">' + result[i].download_progress + '%</span></div></div></div></td>' +
                '<td data-field="download_speed" data-key="1-0-5" class=""><div class="layui-table-cell laytable-cell-1-0-5" align="center"lay-filter="down_speed-' + result[i].chat + '-' + result[i].id + '">' + result[i].download_speed + '</div></td>' +
                "  </tr>";
              obj.append(tr)
              download_list_table_data.push(result[i])

              if (download_list_table_data.length == 1) {
                $(".layui-none").remove()
              }

              element.render()

            }

            element.render()
          }
        });

      };


      function update_download_status() {
        $.ajax({
          url: "get_download_status"
          , type: "get"
          , async: false
          , dataType: "json"
          , success: function (result) {
            $("#download_speed_title").html(result.download_speed)
          }
        });

      };


      var update_download_list_int = self.setInterval(update_download_list, 1000);
      var update_download_status_int = self.setInterval(update_download_status, 1000);
      var update_already_download_list_int = 0;


      function update_already_download_list() {
        $.ajax({
          url: "get_download_list?already_down=true"
          , type: "get"
          , async: false
          , dataType: "json"
          , success: function (result) {
            // if not exist then add
            for (var i = 0, len = result.length; i < len; i++) {
              if (result[i].download_progress != 100) {
                continue
              }

              find_iter = false

              for (var j = 0, len2 = already_download_list_data.length; j < len2; j++) {
                if (result[i].chat == download_list_table_data[i].chat && result[i].id == already_download_list_data[j].id) {
                  find_iter = true
                  break
                }
              }

              if (find_iter) {
                continue;
              }
              // not found
              obj = $('div[lay-id="already_download_list"]  .layui-table-body .layui-table tbody')
              var tr = ' <tr data-index="' + result[i].chat + '-' + result[i].id + '">' +
                '<td data-field="id" data-key="2-0-0" class=""><div class="layui-table-cell laytable-cell-2-0-0">' + result[i].id + '</div></td>' +
                '<td data-field="filename" data-key="2-0-1" class=""><div class="layui-table-cell laytable-cell-2-0-1" align="center">' + result[i].filename + '</div></td>' +
                '<td data-field="total_size" data-key="2-0-2" class=""><div class="layui-table-cell laytable-cell-2-0-2" align="center">' + result[i].total_size + '</div></td>' +
                '<td data-field="save_path" data-key="2-0-3" class=""><div class="layui-table-cell laytable-cell-2-0-3" align="center">' + result[i].save_path + '</div></td>' +
                "  </tr>";
              obj.append(tr)

              already_download_list_data.push(result[i])

              if (already_download_list_data.length == 1) {
                $(".layui-none").remove()
              }
              element.render()
            }

            element.render()
          }
        });

      };


      // è‡ªè¨‚ä¸‹è¼‰åŠŸèƒ½
      function loadGroups() {
        console.log('=== loadGroups called ===');
        $.ajax({
          url: "/get_groups",
          type: "GET",
          dataType: "json",
          success: function(result) {
            console.log('loadGroups success:', result);
            if (result.success) {
              // æ›´æ–°ç¾¤çµ„è¡¨æ ¼
              const tbody = $("#groups-tbody");
              tbody.empty();
              
              // æ›´æ–°ç¾¤çµ„é¸æ“‡ä¸‹æ‹‰é¸å–®
              const select = $("select[name='chat_id']");
              select.empty();
              select.append('<option value="">è«‹é¸æ“‡ç¾¤çµ„</option>');
              
              console.log('Groups data:', result.groups);
              if (result.groups && result.groups.length > 0) {
                console.log('Processing', result.groups.length, 'groups');
                result.groups.forEach(function(group) {
                  console.log('Processing group:', group);
                  // ç¢ºå®šç¾¤çµ„ç‹€æ…‹å’Œé¡å‹
                  let status = 'æ­£å¸¸';
                  let statusColor = 'layui-bg-green';
                  let groupType = 'ç§äºº';
                  
                  if (group.pending_count > 0) {
                    status = 'æœ‰å¾…ä¸‹è¼‰é …ç›®';
                    statusColor = 'layui-bg-orange';
                  }
                  
                  // æ ¹æ“šChat IDåˆ¤æ–·é¡å‹
                  if (group.chat_id.toString().startsWith('-100')) {
                    groupType = 'è¶…ç´šç¾¤çµ„/é »é“';
                  } else if (group.chat_id.toString().startsWith('-')) {
                    groupType = 'ç¾¤çµ„';
                  }
                  
                  // æ·»åŠ åˆ°è¡¨æ ¼
                  tbody.append(`
                    <tr data-chat-id="${group.chat_id}">
                      <td>
                        <input type="checkbox" name="group-select" value="${group.chat_id}" lay-skin="primary" onchange="updateSelectedCount()">
                      </td>
                      <td>
                        <div>
                          <span class="group-name" data-chat-id="${group.chat_id}" style="font-weight: bold;">${group.name || 'Chat ' + group.chat_id}</span>
                        </div>
                      </td>
                      <td><code style="font-size: 12px;">${group.chat_id}</code></td>
                      <td>
                        <span class="${group.pending_count > 0 ? 'layui-badge layui-bg-orange' : 'layui-badge'}">${group.pending_count}</span>
                      </td>
                      <td>
                        <span class="layui-badge ${statusColor}">${status}</span>
                      </td>
                      <td>
                        <span class="layui-badge layui-bg-cyan">${groupType}</span>
                      </td>
                      <td>
                        <div class="layui-btn-group">
                          <button class="layui-btn layui-btn-xs btn-edit-group" data-chat-id="${group.chat_id}" data-group-name="${group.name || ''}" title="ç·¨è¼¯ç¾¤çµ„åç¨±">
                            <i class="layui-icon layui-icon-edit"></i>
                          </button>
                          <button class="layui-btn layui-btn-normal layui-btn-xs btn-check-access" data-chat-id="${group.chat_id}" title="æª¢æŸ¥è¨ªå•æ¬Šé™">
                            <i class="layui-icon layui-icon-survey"></i>
                          </button>
                          <button class="layui-btn layui-btn-warm layui-btn-xs btn-clear-group" data-chat-id="${group.chat_id}" title="æ¸…ç©ºç¾¤çµ„è¨Šæ¯">
                            <i class="layui-icon layui-icon-close"></i>
                          </button>
                          <button class="layui-btn layui-btn-danger layui-btn-xs btn-delete-group" data-chat-id="${group.chat_id}" title="åˆªé™¤ç¾¤çµ„">
                            <i class="layui-icon layui-icon-delete"></i>
                          </button>
                        </div>
                      </td>
                    </tr>
                  `);
                  
                  // æ·»åŠ åˆ°ä¸‹æ‹‰é¸å–®
                  select.append(`<option value="${group.chat_id}">${group.name} (${group.chat_id})</option>`);
                });
                // æ›´æ–°çµ±è¨ˆä¿¡æ¯
                updateGroupStats(result.groups);
              } else {
                tbody.append('<tr><td colspan="7" style="text-align: center;">æš«ç„¡ç¾¤çµ„</td></tr>');
                updateGroupStats([]);
              }
              
              // é‡æ–°æ¸²æŸ“è¡¨å–®
              layui.form.render('select');
              layui.form.render('checkbox');
            } else {
              console.error('loadGroups failed:', result.error);
              layer.msg("è¼‰å…¥ç¾¤çµ„å¤±æ•—: " + result.error, {icon: 2});
            }
          },
          error: function(xhr, status, error) {
            console.error('loadGroups error:', xhr, status, error);
            layer.msg("è¼‰å…¥ç¾¤çµ„å¤±æ•—: " + error, {icon: 2});
          }
        });
      }
      
      // æ›´æ–°ç¾¤çµ„çµ±è¨ˆä¿¡æ¯
      function updateGroupStats(groups) {
        const totalGroups = groups.length;
        let pendingMessages = 0;
        let activeGroups = 0;
        let emptyGroups = 0;
        
        groups.forEach(group => {
          pendingMessages += group.pending_count || 0;
          if (group.pending_count > 0) {
            activeGroups++;
          } else {
            emptyGroups++;
          }
        });
        
        $('#stats-total-groups').text(totalGroups);
        $('#stats-pending-messages').text(pendingMessages);
        $('#stats-active-groups').text(activeGroups);
        $('#stats-empty-groups').text(emptyGroups);
        $('#total-groups').text(`ç¸½å…±ï¼š${totalGroups} å€‹ç¾¤çµ„`);
      }
      
      // æ›´æ–°é¸ä¸­æ•¸é‡
      function updateSelectedCount() {
        const selectedCount = $('input[name="group-select"]:checked').length;
        $('#selected-count').text(`å·²é¸æ“‡ï¼š${selectedCount} å€‹ç¾¤çµ„`);
      }
      
      // å…¨é¸/å–æ¶ˆå…¨é¸
      $(document).on('change', '#select-all-groups', function() {
        const isChecked = $(this).is(':checked');
        $('input[name="group-select"]').prop('checked', isChecked);
        layui.form.render('checkbox');
        updateSelectedCount();
      });
      
      // æœå°‹ç¾¤çµ„
      window.searchGroups = function() {
        const searchTerm = $('#group-search').val().toLowerCase().trim();
        if (!searchTerm) {
          $('tbody#groups-tbody tr').show();
          return;
        }
        
        $('tbody#groups-tbody tr').each(function() {
          const row = $(this);
          const groupName = row.find('.group-name').text().toLowerCase();
          const chatId = row.find('code').text().toLowerCase();
          
          if (groupName.includes(searchTerm) || chatId.includes(searchTerm)) {
            row.show();
          } else {
            row.hide();
          }
        });
      }
      
      // å¾é€£çµåŒ¯å…¥ç¾¤çµ„
      window.importGroupFromLink = function() {
        layer.prompt({
          title: 'å¾é€£çµåŒ¯å…¥ç¾¤çµ„',
          content: `
            <div style="margin-top: 10px;">
              <label>Telegram ç¾¤çµ„é€£çµ:</label>
              <input type="text" id="import-link" placeholder="è«‹è¼¸å…¥ https://t.me/... é€£çµ" style="width: 100%; margin: 5px 0; padding: 8px; border: 1px solid #ccc;">
              <div style="font-size: 12px; color: #666; margin-top: 5px;">
                æ”¯æ´æ ¼å¼ï¼šhttps://t.me/groupname æˆ– https://t.me/c/1234567890/123
              </div>
            </div>
          `,
          btn: ['è§£æä¸¦åŒ¯å…¥', 'å–æ¶ˆ'],
          yes: function(index, layero) {
            const link = layero.find('#import-link').val().trim();
            
            if (!link) {
              layer.msg('è«‹è¼¸å…¥ç¾¤çµ„é€£çµ', {icon: 2});
              return;
            }
            
            if (!link.includes('t.me/')) {
              layer.msg('è«‹è¼¸å…¥æœ‰æ•ˆçš„ Telegram é€£çµ', {icon: 2});
              return;
            }
            
            parseAndImportGroup(link);
            layer.close(index);
          }
        });
      }
      
      // è§£æä¸¦åŒ¯å…¥ç¾¤çµ„
      function parseAndImportGroup(link) {
        layer.msg('æ­£åœ¨è§£æç¾¤çµ„è³‡è¨Š...', {icon: 16, time: 0});
        
        let chatId = '';
        let groupName = '';
        
        try {
          // æ¸…ç†é€£çµï¼Œç§»é™¤ä¸å¿…è¦çš„éƒ¨åˆ†
          link = link.replace(/\?.*$/, '').replace(/#.*$/, '');
          
          if (link.includes('/c/')) {
            // ç§æœ‰ç¾¤çµ„é€£çµæ ¼å¼: https://t.me/c/1234567890/123 æˆ– https://t.me/c/1234567890
            const matches = link.match(/\/c\/(\d+)/);
            if (matches) {
              // Telegram ç§æœ‰ç¾¤çµ„ ID æ ¼å¼æ˜¯ -100 + ç¾¤çµ„ ID
              chatId = '-100' + matches[1];
              groupName = `ç§æœ‰ç¾¤çµ„ ${matches[1]}`;
            }
          } else if (link.includes('/joinchat/')) {
            // é‚€è«‹é€£çµæ ¼å¼: https://t.me/joinchat/XXXXX
            layer.closeAll();
            layer.msg('é‚€è«‹é€£çµç„¡æ³•ç›´æ¥è§£æ Chat IDï¼Œè«‹æ‰‹å‹•æ·»åŠ æˆ–å…ˆåŠ å…¥ç¾¤çµ„å¾Œä½¿ç”¨ç§æœ‰é€£çµ', {icon: 0, time: 5000});
            return;
          } else {
            // å…¬é–‹ç¾¤çµ„é€£çµæ ¼å¼: https://t.me/groupname
            const matches = link.match(/t\.me\/([a-zA-Z0-9_]+)/);
            if (matches) {
              const username = matches[1];
              groupName = `@${username}`;
              
              // æç¤ºç”¨æˆ¶è¼¸å…¥ Chat ID
              layer.closeAll();
              layer.prompt({
                title: `è§£æåˆ°å…¬é–‹ç¾¤çµ„: ${groupName}`,
                content: `
                  <div style="margin-top: 10px;">
                    <p>å…¬é–‹ç¾¤çµ„éœ€è¦æ‚¨æä¾› Chat IDã€‚</p>
                    <p>æ‚¨å¯ä»¥é€šéä»¥ä¸‹æ–¹å¼ç²å–ï¼š</p>
                    <ul style="margin: 10px 0; padding-left: 20px; font-size: 12px; color: #666;">
                      <li>ä½¿ç”¨ @userinfobot åœ¨ç¾¤çµ„ä¸­ç™¼é€æ¶ˆæ¯ç²å–</li>
                      <li>ä½¿ç”¨ @getidsbot è½‰ç™¼ç¾¤çµ„æ¶ˆæ¯ç²å–</li>
                      <li>æˆ–è€…å¾ç¾¤çµ„çš„ç§æœ‰é€£çµä¸­ç²å–</li>
                    </ul>
                    <label>è«‹è¼¸å…¥ Chat ID:</label>
                    <input type="text" placeholder="ä¾‹å¦‚: -1001234567890" style="width: 100%; margin: 5px 0; padding: 8px; border: 1px solid #ccc;">
                  </div>
                `,
                btn: ['æ·»åŠ ç¾¤çµ„', 'å–æ¶ˆ'],
                yes: function(index, layero) {
                  const inputChatId = layero.find('input').val().trim();
                  if (!inputChatId) {
                    layer.msg('è«‹è¼¸å…¥ Chat ID', {icon: 2});
                    return;
                  }
                  
                  if (!inputChatId.match(/^-?\d+$/)) {
                    layer.msg('Chat ID æ ¼å¼ä¸æ­£ç¢ºï¼Œæ‡‰è©²æ˜¯æ•¸å­—', {icon: 2});
                    return;
                  }
                  
                  layer.close(index);
                  addGroup(inputChatId, groupName);
                }
              });
              return;
            }
          }
          
          if (chatId) {
            layer.closeAll();
            addGroup(chatId, groupName);
          } else {
            layer.closeAll();
            layer.msg('ç„¡æ³•è§£æç¾¤çµ„è³‡è¨Šï¼Œè«‹æª¢æŸ¥é€£çµæ ¼å¼', {icon: 2});
          }
        } catch (e) {
          console.error('è§£æé€£çµéŒ¯èª¤:', e);
          layer.closeAll();
          layer.msg('é€£çµè§£æå¤±æ•—', {icon: 2});
        }
      }
      
      
      // ç²å–ç¾¤çµ„é¡å‹
      function getGroupType(chatId) {
        if (chatId.toString().startsWith('-100')) {
          return 'è¶…ç´šç¾¤çµ„/é »é“';
        } else if (chatId.toString().startsWith('-')) {
          return 'ç¾¤çµ„';
        }
        return 'ç§äºº';
      }
      
      // åŒ¯å‡ºé¸ä¸­ç¾¤çµ„
      window.exportSelectedGroups = function() {
        const selectedChatIds = [];
        $('input[name="group-select"]:checked').each(function() {
          selectedChatIds.push($(this).val());
        });
        
        if (selectedChatIds.length === 0) {
          layer.msg('è«‹é¸æ“‡è¦åŒ¯å‡ºçš„ç¾¤çµ„', {icon: 2});
          return;
        }
        
        // ç²å–é¸ä¸­ç¾¤çµ„çš„è©³ç´°ä¿¡æ¯
        const exportData = [];
        selectedChatIds.forEach(chatId => {
          const row = $(`tr[data-chat-id="${chatId}"]`);
          const groupName = row.find('.group-name').text();
          const pendingCount = parseInt(row.find('.layui-badge').first().text()) || 0;
          
          exportData.push({
            chat_id: chatId,
            name: groupName,
            pending_count: pendingCount,
            type: getGroupType(chatId)
          });
        });
        
        // ç”ŸæˆJSONæª”æ¡ˆ
        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(dataBlob);
        
        // å‰µå»ºä¸‹è¼‰é€£çµ
        const link = document.createElement('a');
        link.href = url;
        link.download = `groups_export_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        layer.msg(`å·²åŒ¯å‡º ${selectedChatIds.length} å€‹ç¾¤çµ„`, {icon: 1});
      }
      
      // æ–°å¢ç¾¤çµ„å°è©±æ¡†
      window.addGroupDialog = function() {
        layer.prompt({
          title: 'æ–°å¢ç¾¤çµ„',
          content: `
            <div style="margin-top: 10px;">
              <label>Chat ID:</label>
              <input type="text" id="new-chat-id" placeholder="è«‹è¼¸å…¥ Chat ID (ä¾‹å¦‚: -1001234567890)" style="width: 100%; margin: 5px 0; padding: 8px; border: 1px solid #ccc;">
              <label>ç¾¤çµ„åç¨±:</label>
              <input type="text" id="new-group-name" placeholder="è«‹è¼¸å…¥ç¾¤çµ„åç¨±" style="width: 100%; margin: 5px 0; padding: 8px; border: 1px solid #ccc;">
            </div>
          `,
          btn: ['ç¢ºå®š', 'å–æ¶ˆ'],
          yes: function(index, layero) {
            const chatId = layero.find('#new-chat-id').val().trim();
            const groupName = layero.find('#new-group-name').val().trim();
            
            if (!chatId) {
              layer.msg('è«‹è¼¸å…¥ Chat ID', {icon: 2});
              return;
            }
            
            if (!groupName) {
              layer.msg('è«‹è¼¸å…¥ç¾¤çµ„åç¨±', {icon: 2});
              return;
            }
            
            addGroup(chatId, groupName);
            layer.close(index);
          }
        });
      }
      
      // æ–°å¢ç¾¤çµ„
      function addGroup(chatId, name) {
        $.ajax({
          url: '/add_group',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({ chat_id: chatId, name: name }),
          success: function(result) {
            if (result.success) {
              layer.msg(result.message, {icon: 1});
              loadGroups(); // é‡æ–°è¼‰å…¥ç¾¤çµ„åˆ—è¡¨
            } else {
              layer.msg('æ–°å¢å¤±æ•—: ' + result.error, {icon: 2});
            }
          },
          error: function() {
            layer.msg('æ–°å¢å¤±æ•—ï¼šç¶²è·¯éŒ¯èª¤', {icon: 2});
          }
        });
      }
      
      // ç·¨è¼¯ç¾¤çµ„åç¨±
      function editGroupName(chatId, currentName) {
        layer.prompt({
          title: 'ç·¨è¼¯ç¾¤çµ„åç¨±',
          value: currentName,
          yes: function(index, layero) {
            const newName = layero.find('input').val().trim();
            
            if (!newName) {
              layer.msg('è«‹è¼¸å…¥ç¾¤çµ„åç¨±', {icon: 2});
              return;
            }
            
            if (newName === currentName) {
              layer.close(index);
              return;
            }
            
            $.ajax({
              url: '/edit_group',
              type: 'POST',
              contentType: 'application/json',
              data: JSON.stringify({ chat_id: chatId, name: newName }),
              success: function(result) {
                if (result.success) {
                  layer.msg(result.message, {icon: 1});
                  loadGroups(); // é‡æ–°è¼‰å…¥ç¾¤çµ„åˆ—è¡¨
                  loadAllGroupOptions(); // é‡æ–°è¼‰å…¥ç¯©é¸é¸é …
                  loadDownloadHistory(currentPage); // é‡æ–°è¼‰å…¥ä¸‹è¼‰æ­·å²ä»¥æ›´æ–°ç¾¤çµ„åç¨±
                } else {
                  layer.msg('ç·¨è¼¯å¤±æ•—: ' + result.error, {icon: 2});
                }
              },
              error: function() {
                layer.msg('ç·¨è¼¯å¤±æ•—ï¼šç¶²è·¯éŒ¯èª¤', {icon: 2});
              }
            });
            
            layer.close(index);
          }
        });
      }
      
      // åˆªé™¤å–®å€‹ç¾¤çµ„
      function deleteGroup(chatId) {
        layer.confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹ç¾¤çµ„å—ï¼Ÿæ­¤æ“ä½œæœƒåŒæ™‚åˆªé™¤è©²ç¾¤çµ„çš„æ‰€æœ‰ä¸‹è¼‰ä»»å‹™ã€‚', {
          btn: ['ç¢ºå®š', 'å–æ¶ˆ']
        }, function(index) {
          $.ajax({
            url: '/delete_group',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ chat_id: chatId }),
            success: function(result) {
              if (result.success) {
                layer.msg(result.message, {icon: 1});
                loadGroups(); // é‡æ–°è¼‰å…¥ç¾¤çµ„åˆ—è¡¨
                loadDownloadHistory(); // é‡æ–°è¼‰å…¥ä¸‹è¼‰æ­·å²
              } else {
                layer.msg('åˆªé™¤å¤±æ•—: ' + result.error, {icon: 2});
              }
            },
            error: function() {
              layer.msg('åˆªé™¤å¤±æ•—ï¼šç¶²è·¯éŒ¯èª¤', {icon: 2});
            }
          });
          layer.close(index);
        });
      }
      
      // æ‰¹é‡åˆªé™¤ç¾¤çµ„
      window.deleteSelectedGroups = function() {
        const selectedChatIds = [];
        $('input[name="group-select"]:checked').each(function() {
          selectedChatIds.push($(this).val());
        });
        
        if (selectedChatIds.length === 0) {
          layer.msg('è«‹é¸æ“‡è¦åˆªé™¤çš„ç¾¤çµ„', {icon: 2});
          return;
        }
        
        layer.confirm(`ç¢ºå®šè¦åˆªé™¤é¸ä¸­çš„ ${selectedChatIds.length} å€‹ç¾¤çµ„å—ï¼Ÿæ­¤æ“ä½œæœƒåŒæ™‚åˆªé™¤é€™äº›ç¾¤çµ„çš„æ‰€æœ‰ä¸‹è¼‰ä»»å‹™ã€‚`, {
          btn: ['ç¢ºå®š', 'å–æ¶ˆ']
        }, function(index) {
          $.ajax({
            url: '/delete_multiple_groups',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ chat_ids: selectedChatIds }),
            success: function(result) {
              if (result.success) {
                layer.msg(result.message, {icon: 1});
                loadGroups(); // é‡æ–°è¼‰å…¥ç¾¤çµ„åˆ—è¡¨
                loadDownloadHistory(); // é‡æ–°è¼‰å…¥ä¸‹è¼‰æ­·å²
              } else {
                layer.msg('åˆªé™¤å¤±æ•—: ' + result.error, {icon: 2});
              }
            },
            error: function() {
              layer.msg('åˆªé™¤å¤±æ•—ï¼šç¶²è·¯éŒ¯èª¤', {icon: 2});
            }
          });
          layer.close(index);
        });
      }
      
      // æ‰¹é‡æ¸…ç©ºç¾¤çµ„è¨Šæ¯
      // æª¢æŸ¥ç¾¤çµ„è¨ªå•æ¬Šé™
      window.checkGroupAccess = function(chatId) {
        layer.msg('æ­£åœ¨æª¢æŸ¥ç¾¤çµ„è¨ªå•æ¬Šé™...', {icon: 16, time: 0});
        
        $.ajax({
          url: '/check_group_access',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({ chat_id: chatId }),
          success: function(result) {
            layer.closeAll();
            
            if (result.success) {
              const info = result.info;
              let content = '';
              let icon = 1; // æˆåŠŸåœ–æ¨™
              let title = 'ç¾¤çµ„è¨ªå•æª¢æŸ¥çµæœ';
              
              if (info.accessible) {
                content = `
                  <div style="padding: 10px;">
                    <p><strong>âœ… ç¾¤çµ„å¯æ­£å¸¸è¨ªå•</strong></p>
                    <hr style="margin: 10px 0;">
                    <p><strong>ç¾¤çµ„åç¨±:</strong> ${info.title}</p>
                    <p><strong>ç¾¤çµ„é¡å‹:</strong> ${info.type}</p>
                    <p><strong>æˆå“¡æ•¸é‡:</strong> ${info.members_count}</p>
                    <p><strong>Chat ID:</strong> ${chatId}</p>
                    <hr style="margin: 10px 0;">
                    <p style="color: #5FB878; font-size: 12px;">æ©Ÿå™¨äººå¯ä»¥æ­£å¸¸å¾æ­¤ç¾¤çµ„ä¸‹è¼‰è¨Šæ¯</p>
                  </div>
                `;
              } else {
                icon = 2; // éŒ¯èª¤åœ–æ¨™
                content = `
                  <div style="padding: 10px;">
                    <p><strong>âŒ ç¾¤çµ„ç„¡æ³•è¨ªå•</strong></p>
                    <hr style="margin: 10px 0;">
                    <p><strong>Chat ID:</strong> ${chatId}</p>
                    <p><strong>éŒ¯èª¤ä¿¡æ¯:</strong> ${info.error}</p>
                    <hr style="margin: 10px 0;">
                    <p style="color: #FF5722; font-size: 12px;"><strong>å¯èƒ½çš„åŸå› :</strong></p>
                    <ul style="margin: 5px 0; padding-left: 20px; font-size: 12px; color: #666;">
                      <li>æ©Ÿå™¨äººè¢«å¾ç¾¤çµ„ä¸­ç§»é™¤</li>
                      <li>ç¾¤çµ„è¢«åˆªé™¤æˆ–è¨­ç‚ºç§äºº</li>
                      <li>æ©Ÿå™¨äººç¼ºä¹å¿…è¦æ¬Šé™</li>
                      <li>ç¾¤çµ„ ID ä¸æ­£ç¢º</li>
                    </ul>
                    <hr style="margin: 10px 0;">
                    <p style="color: #FF5722; font-size: 12px;">å»ºè­°å¾ä¸‹è¼‰åˆ—è¡¨ä¸­ç§»é™¤æ­¤ç¾¤çµ„çš„é …ç›®</p>
                  </div>
                `;
              }
              
              layer.open({
                type: 1,
                title: title,
                icon: icon,
                area: ['500px', 'auto'],
                content: content,
                btn: info.accessible ? ['ç¢ºå®š'] : ['ç¢ºå®š', 'æ¸…ç©ºæ­¤ç¾¤çµ„'],
                yes: function(index) {
                  layer.close(index);
                },
                btn2: function(index) {
                  // å¦‚æœç¾¤çµ„ä¸å¯è¨ªå•ï¼Œæä¾›æ¸…ç©ºé¸é …
                  layer.confirm('ç¢ºå®šè¦æ¸…ç©ºæ­¤ç¾¤çµ„çš„æ‰€æœ‰ä¸‹è¼‰é …ç›®å—ï¼Ÿ', function(confirmIndex) {
                    clearGroupIds(chatId);
                    layer.close(confirmIndex);
                    layer.close(index);
                  });
                  return false; // é˜»æ­¢å°è©±æ¡†é—œé–‰
                }
              });
            } else {
              layer.msg('æª¢æŸ¥å¤±æ•—: ' + result.error, {icon: 2});
            }
          },
          error: function() {
            layer.closeAll();
            layer.msg('æª¢æŸ¥è«‹æ±‚å¤±æ•—', {icon: 2});
          }
        });
      }
      
      window.clearSelectedGroups = function() {
        const selectedChatIds = [];
        $('input[name="group-select"]:checked').each(function() {
          selectedChatIds.push($(this).val());
        });
        
        if (selectedChatIds.length === 0) {
          layer.msg('è«‹é¸æ“‡è¦æ¸…ç©ºçš„ç¾¤çµ„', {icon: 2});
          return;
        }
        
        layer.confirm(`ç¢ºå®šè¦æ¸…ç©ºé¸ä¸­çš„ ${selectedChatIds.length} å€‹ç¾¤çµ„çš„æ‰€æœ‰è¨Šæ¯å—ï¼Ÿ`, {
          btn: ['ç¢ºå®š', 'å–æ¶ˆ']
        }, function(index) {
          $.ajax({
            url: '/clear_multiple_groups',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ chat_ids: selectedChatIds }),
            success: function(result) {
              if (result.success) {
                layer.msg(result.message, {icon: 1});
                loadGroups(); // é‡æ–°è¼‰å…¥ç¾¤çµ„åˆ—è¡¨
                loadDownloadHistory(); // é‡æ–°è¼‰å…¥ä¸‹è¼‰æ­·å²
              } else {
                layer.msg('æ¸…ç©ºå¤±æ•—: ' + result.error, {icon: 2});
              }
            },
            error: function() {
              layer.msg('æ¸…ç©ºå¤±æ•—ï¼šç¶²è·¯éŒ¯èª¤', {icon: 2});
            }
          });
          layer.close(index);
        });
      }

      let currentPage = 1;
      const pageLimit = 20; // æ¯é é¡¯ç¤º20æ¢è¨˜éŒ„

      // è¼‰å…¥æ‰€æœ‰ç¾¤çµ„é¸é …ç”¨æ–¼ç¯©é¸
      function loadAllGroupOptions() {
        $.ajax({
          url: '/get_all_groups',
          type: 'GET',
          dataType: 'json',
          success: function(result) {
            if (result.success) {
              const groupSelect = $('#group-filter');
              const currentValue = groupSelect.val();
              
              // æ¸…é™¤èˆŠé¸é …ï¼ˆä¿ç•™"å…¨éƒ¨ç¾¤çµ„"ï¼‰
              groupSelect.find('option[value!=""]').remove();
              
              // æ·»åŠ æ‰€æœ‰ç¾¤çµ„é¸é …
              result.groups.forEach(function(groupName) {
                groupSelect.append(`<option value="${groupName}">${groupName}</option>`);
              });
              
              // æ¢å¾©ä¹‹å‰çš„é¸æ“‡
              if (currentValue) {
                groupSelect.val(currentValue);
              }
              
              layui.form.render('select');
            }
          },
          error: function() {
            console.error('ç„¡æ³•è¼‰å…¥ç¾¤çµ„é¸é …');
          }
        });
      }

      function loadDownloadHistory(page = 1, groupFilter = '', statusFilter = '') {
        currentPage = page;
        
        // æ§‹å»ºæŸ¥è©¢åƒæ•¸
        let url = `/get_download_history?page=${page}&limit=${pageLimit}`;
        if (groupFilter) {
          url += `&group_filter=${encodeURIComponent(groupFilter)}`;
        }
        if (statusFilter) {
          url += `&status_filter=${encodeURIComponent(statusFilter)}`;
        }
        
        $.ajax({
          url: url,
          type: "GET", 
          dataType: "json",
          success: function(result) {
            if (result.success) {
              const tbody = $("#download-history-tbody");
              tbody.empty();
              
              if (result.history && result.history.length > 0) {
                // æ”¶é›†æ‰€æœ‰ç¾¤çµ„åç¨±ç”¨æ–¼ç¯©é¸ä¸‹æ‹‰é¸å–®
                const groupNames = new Set();
                
                result.history.forEach(function(item) {
                  // æ·»åŠ ç¾¤çµ„åç¨±åˆ°é›†åˆ
                  if (item.chat_name) {
                    groupNames.add(item.chat_name);
                  }
                  let statusClass, statusText, actionButton;
                  
                  if (item.status === 'downloaded' || item.status === 'downloaded_ids') {
                    statusClass = 'layui-bg-green';
                    statusText = 'å·²ä¸‹è¼‰';
                    actionButton = '<span class="layui-btn layui-btn-disabled layui-btn-xs">å·²å®Œæˆ</span>';
                  } else if (item.status === 'failed' || item.status === 'failed_ids') {
                    statusClass = 'layui-bg-red';
                    statusText = 'å¤±æ•—';
                    actionButton = `<button class="layui-btn layui-btn-xs" onclick="retryDownload('${item.chat_id}', '${item.message_id}')">
                      <i class="layui-icon layui-icon-refresh"></i> é‡è©¦
                    </button>`;
                  } else if (item.status === 'pending') {
                    statusClass = 'layui-bg-orange';
                    statusText = 'å¾…ä¸‹è¼‰';
                    actionButton = '<span class="layui-btn layui-btn-disabled layui-btn-xs">ç­‰å¾…ä¸­</span>';
                  } else {
                    statusClass = 'layui-bg-blue';
                    statusText = 'è™•ç†ä¸­';
                    actionButton = '<span class="layui-btn layui-btn-disabled layui-btn-xs">è™•ç†ä¸­</span>';
                  }
                  
                  // åªæœ‰pendingç‹€æ…‹çš„é …ç›®æ‰èƒ½è¢«é¸ä¸­
                  let checkboxHtml = '';
                  if (item.status === 'pending') {
                    // æª¢æŸ¥æ˜¯å¦æ‡‰è©²è‡ªå‹•é¸å–
                    const autoChecked = item.auto_select ? 'checked' : '';
                    checkboxHtml = `<input type="checkbox" class="task-checkbox" value="${item.chat_id},${item.message_id}" lay-skin="primary" title="" ${autoChecked}>`;
                  }
                  
                  tbody.append(`
                    <tr>
                      <td>${checkboxHtml}</td>
                      <td>${item.timestamp}</td>
                      <td>${item.chat_name || item.chat_id}</td>
                      <td>${item.message_id}</td>
                      <td><span class="layui-badge ${statusClass}">${statusText}</span></td>
                      <td>${actionButton}</td>
                    </tr>
                  `);
                });
                
                        // ç¾¤çµ„ç¯©é¸é¸é …åœ¨é é¢åˆå§‹åŒ–æ™‚è¼‰å…¥ï¼Œé€™è£¡ä¸éœ€è¦å†æ›´æ–°
                
                // æ›´æ–°ç¯©é¸è¨ˆæ•¸
                $('#filtered-count').text(`é¡¯ç¤ºï¼š${result.history.length} é …ç›®`);
                
                // æ›´æ–°åˆ†é è³‡è¨Š
                if (result.pagination) {
                  updatePagination(result.pagination);
                } else {
                  $("#history-pagination").hide();
                }
              } else {
                tbody.append('<tr><td colspan="6" style="text-align: center;">æš«ç„¡ä¸‹è¼‰æ­·å²</td></tr>');
                $("#history-pagination").hide();
              }
            } else {
              $("#download-history-tbody").html('<tr><td colspan="6" style="text-align: center; color: red;">è¼‰å…¥å¤±æ•—: ' + result.error + '</td></tr>');
            }
          },
          error: function() {
            $("#download-history-tbody").html('<tr><td colspan="6" style="text-align: center; color: red;">è¼‰å…¥å¤±æ•—</td></tr>');
          }
        });
      }

      function updatePagination(pagination) {
        if (pagination.total > 0) {
          $("#history-pagination").show();
          
          // ä½¿ç”¨Layuiçš„laypageçµ„ä»¶
          laypage.render({
            elem: 'history-pagination',
            count: pagination.total,
            limit: pageLimit,
            curr: pagination.page,
            layout: ['count', 'prev', 'page', 'next', 'skip'],
            theme: '#009688',
            jump: function(obj, first) {
              if (!first) {
                loadDownloadHistory(obj.curr);
              }
            }
          });
        } else {
          $("#history-pagination").hide();
        }
      }

      function clearGroupIds(chatId) {
        layer.confirm('ç¢ºå®šè¦æ¸…ç©ºè©²ç¾¤çµ„çš„ä¸‹è¼‰éšŠåˆ—å—ï¼Ÿ', {icon: 3, title:'æç¤º'}, function(index){
          $.ajax({
            url: "/clear_download_ids",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({chat_id: chatId}),
            dataType: "json",
            success: function(result) {
              if (result.success) {
                layer.msg(result.message, {icon: 1});
                loadGroups(); // é‡æ–°è¼‰å…¥ç¾¤çµ„è³‡æ–™
                loadDownloadHistory(1); // é‡æ–°è¼‰å…¥ä¸‹è¼‰æ­·å²
              } else {
                layer.msg("æ“ä½œå¤±æ•—: " + result.error, {icon: 2});
              }
            }
          });
          layer.close(index);
        });
      }

      function retryDownload(chatId, messageId) {
        layer.confirm('ç¢ºå®šè¦é‡è©¦ä¸‹è¼‰é€™å€‹è¨Šæ¯å—ï¼Ÿ', {icon: 3, title: 'ç¢ºèªé‡è©¦'}, function(index) {
          $.ajax({
            url: '/retry_download',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
              chat_id: chatId,
              message_id: messageId
            }),
            success: function(response) {
              if (response.success) {
                layer.msg(response.message, {icon: 1});
                // é‡æ–°è¼‰å…¥ä¸‹è¼‰æ­·å²
                setTimeout(() => {
                  loadDownloadHistory(currentPage);
                }, 1000);
              } else {
                layer.msg('é‡è©¦å¤±æ•—: ' + response.error, {icon: 2});
              }
            },
            error: function() {
              layer.msg('é‡è©¦è«‹æ±‚å¤±æ•—', {icon: 2});
            }
          });
          layer.close(index);
        });
      }

      // é¸æ“‡æ¡†ç›¸é—œå‡½æ•¸
      window.selectAllTasks = function() {
        $('.task-checkbox').prop('checked', true);
        $('#select-all-checkbox').prop('checked', true);
      }
      
      window.selectPendingTasks = function() {
        // åªé¸æ“‡å¾…ä¸‹è¼‰ç‹€æ…‹çš„é …ç›®
        $('.task-checkbox').each(function() {
          const row = $(this).closest('tr');
          const statusElement = row.find('.layui-badge');
          if (statusElement.text().includes('å¾…ä¸‹è¼‰') || statusElement.text().includes('æº–å‚™') || statusElement.text().includes('pending')) {
            $(this).prop('checked', true);
          }
        });
        
        // çµ±è¨ˆé¸ä¸­æ•¸é‡ä¸¦é¡¯ç¤ºæ¶ˆæ¯
        const selectedCount = $('.task-checkbox:checked').length;
        if (selectedCount > 0) {
          layer.msg(`å·²é¸æ“‡ ${selectedCount} å€‹å¾…ä¸‹è¼‰é …ç›®`, {icon: 1});
        } else {
          layer.msg('æ²’æœ‰æ‰¾åˆ°å¾…ä¸‹è¼‰çš„é …ç›®', {icon: 3});
        }
      }
      
      window.deselectAllTasks = function() {
        $('.task-checkbox').prop('checked', false);
        $('#select-all-checkbox').prop('checked', false);
      }
      
      // ç¯©é¸åŠŸèƒ½
      window.applyFilters = function() {
        const groupFilter = $('#group-filter').val();
        const statusFilter = $('#status-filter').val();
        
        // é‡æ–°è¼‰å…¥ç¬¬ä¸€é ï¼Œå¸¶ä¸Šç¯©é¸åƒæ•¸
        loadDownloadHistory(1, groupFilter, statusFilter);
      }
      
      window.clearFilters = function() {
        $('#group-filter').val('');
        $('#status-filter').val('');
        layui.form.render('select');
        
        // é‡æ–°è¼‰å…¥ç¬¬ä¸€é ï¼Œä¸å¸¶ç¯©é¸åƒæ•¸
        loadDownloadHistory(1);
      }
      
      window.removeSelectedTasks = function() {
        let selectedTasks = [];
        $('.task-checkbox:checked').each(function() {
          let value = $(this).val().split(',');
          selectedTasks.push({
            chat_id: value[0],
            message_id: value[1]
          });
        });
        
        if (selectedTasks.length === 0) {
          layer.msg('è«‹å…ˆé¸æ“‡è¦ç§»é™¤çš„é …ç›®', {icon: 3});
          return;
        }
        
        layer.confirm(`ç¢ºå®šè¦å¾ä¸‹è¼‰éšŠåˆ—ä¸­ç§»é™¤ ${selectedTasks.length} å€‹é …ç›®å—ï¼Ÿ`, {
          icon: 3, 
          title: 'ç¢ºèªç§»é™¤'
        }, function(index) {
          $.ajax({
            url: '/remove_selected_tasks',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({tasks: selectedTasks}),
            success: function(response) {
              if (response.success) {
                layer.msg(response.message, {icon: 1});
                // é‡æ–°è¼‰å…¥ä¸‹è¼‰æ­·å²å’Œç¾¤çµ„è³‡è¨Š
                loadDownloadHistory(currentPage);
                loadGroups();
              } else {
                layer.msg('ç§»é™¤å¤±æ•—: ' + response.error, {icon: 2});
              }
            },
            error: function() {
              layer.msg('ç§»é™¤è«‹æ±‚å¤±æ•—', {icon: 2});
            }
          });
          layer.close(index);
        });
      }
      
      window.cleanDownloadedItems = function() {
        layer.confirm('æ¸…ç†å·²ä¸‹è¼‰é …ç›®æœƒå°‡å·²æˆåŠŸä¸‹è¼‰çš„é …ç›®å¾å¾…ä¸‹è¼‰åˆ—è¡¨ä¸­ç§»é™¤ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ', {
          icon: 3, 
          title: 'ç¢ºèªæ¸…ç†'
        }, function(index) {
          $.ajax({
            url: '/clean_downloaded_from_targets',
            type: 'POST',
            success: function(response) {
              if (response.success) {
                layer.msg(response.message, {icon: 1});
                loadDownloadHistory(1); // é‡æ–°è¼‰å…¥æ­·å²ï¼Œå›åˆ°ç¬¬ä¸€é 
                loadGroups(); // é‡æ–°è¼‰å…¥ç¾¤çµ„è³‡è¨Š
              } else {
                layer.msg('æ¸…ç†å¤±æ•—: ' + response.error, {icon: 2});
              }
            },
            error: function() {
              layer.msg('æ¸…ç†è«‹æ±‚å¤±æ•—', {icon: 2});
            }
          });
          layer.close(index);
        });
      }
      
      // æª¢æŸ¥ä¸¦æ¢å¾©æ´»èºçš„ä¸‹è¼‰æœƒè©±
      function checkAndResumeActiveSession() {
        $.ajax({
          url: '/get_download_progress',
          type: 'GET',
          success: function(response) {
            if (response.success && response.session && response.session.active) {
              console.log('Found active download session, resuming monitoring...');
              console.log('Session info:', response.session);
              
              // é¡¯ç¤ºé€²åº¦å€åŸŸ
              $('#download-progress-area').show();
              $('#download_control').show();
              
              // è¨­ç½®åˆå§‹é€²åº¦
              lastCompletedCount = response.completed_count || 0;
              updateTaskProgress(
                response.completed_count || 0,
                response.total_count || response.session.total_tasks,
                response.status_text || 'æ¢å¾©ä¸­...',
                response.total_download_speed || '0.00 B/s'
              );
              
              // é–‹å§‹ç›£æ§
              startDownloadMonitoring();
              
              // ç«‹å³æ›´æ–°ä¸€æ¬¡é é¢è³‡æ–™
              setTimeout(() => {
                loadDownloadHistory(currentPage);
                loadGroups();
              }, 500);
              
              layer.msg('åµæ¸¬åˆ°é€²è¡Œä¸­çš„ä¸‹è¼‰ä»»å‹™ï¼Œå·²æ¢å¾©ç›£æ§', {icon: 1});
            }
          },
          error: function() {
            console.log('Failed to check active session');
          }
        });
      }
      
      // å…¨é¸checkboxè™•ç†
      $(document).on('change', '#select-all-checkbox', function() {
        $('.task-checkbox').prop('checked', $(this).prop('checked'));
      });
      
      // é€²åº¦æ¢ç›¸é—œå‡½æ•¸
      let downloadMonitoringInterval;
      
      function showDownloadProgress(totalTasks) {
        $('#download-progress-area').show();
        $('#task-total').text(totalTasks);
        $('#task-completed').text(0);
        $('#task-status-text').text('æº–å‚™é–‹å§‹ä¸‹è¼‰...');
        
        // åˆå§‹åŒ–é€²åº¦æ¢
        console.log('Initializing progress bar');
        try {
          element.progress('task-progress-bar', '0%');
          console.log('Progress bar initialized successfully');
        } catch (e) {
          console.error('Failed to initialize progress bar:', e);
          // å‚™ç”¨æ–¹æ¡ˆ
          const progressBarElement = $('[lay-filter="task-progress-bar"] .layui-progress-bar');
          progressBarElement.css('width', '0%');
          progressBarElement.attr('lay-percent', '0%');
          progressBarElement.addClass('layui-bg-blue');
        }
        
        $('#concurrent-progress-section').hide();
      }
      
      function updateTaskProgress(completed, total, statusText, downloadSpeed) {
        let percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
        console.log(`Updating task progress: ${completed}/${total} = ${percentage}%`);
        
        $('#task-completed').text(completed);
        $('#task-total').text(total);
        $('#task-status-text').text(statusText || 'ä¸‹è¼‰ä¸­...');
        
        // æ›´æ–°ç¸½ä¸‹è¼‰é€Ÿåº¦ï¼Œåƒè€ƒåŸå§‹é€²åº¦æ¢è¨­è¨ˆ
        if (downloadSpeed) {
          $('#total-download-speed').text(downloadSpeed);
        }
        
        // ä½¿ç”¨ Layui çš„ element.progress æ–¹æ³•ä¾†ç²å¾—æµæš¢å‹•ç•«
        console.log(`Calling element.progress('task-progress-bar', '${percentage}%')`);
        try {
          element.progress('task-progress-bar', percentage + '%');
          console.log('element.progress call successful');
        } catch (e) {
          console.error('element.progress failed:', e);
          // å‚™ç”¨æ–¹æ¡ˆï¼šç›´æ¥è¨­ç½® CSS
          const progressBarElement = $('[lay-filter="task-progress-bar"] .layui-progress-bar');
          progressBarElement.css('width', percentage + '%');
          progressBarElement.attr('lay-percent', percentage + '%');
          
          // æ‰‹å‹•æ›´æ–°ç™¾åˆ†æ¯”æ–‡å­—
          const percentSpan = $('[lay-filter="task-progress-bar"] .layui-progress-text');
          if (percentSpan.length === 0) {
            // å¦‚æœæ²’æœ‰ç™¾åˆ†æ¯”æ–‡å­—å…ƒç´ ï¼Œå‰µå»ºä¸€å€‹
            progressBarElement.parent().append(`<span class="layui-progress-text">${percentage}%</span>`);
          } else {
            percentSpan.text(percentage + '%');
          }
          console.log('Fallback CSS update applied');
        }
        
        // æ ¹æ“šé€²åº¦æ›´æ”¹é¡è‰²ï¼Œå®Œå…¨åƒè€ƒåŸå§‹æª”æ¡ˆä¸‹è¼‰é€²åº¦æ¢è¨­è¨ˆ
        const progressBar = $('[lay-filter="task-progress-bar"] .layui-progress-bar');
        progressBar.removeClass('layui-bg-red layui-bg-blue layui-bg-green');
        if (percentage > 30 && percentage < 100) {
          progressBar.addClass('layui-bg-blue');
        } else if (percentage > 0 && percentage <= 30) {
          progressBar.addClass('layui-bg-red');
        } else if (percentage == 100) {
          progressBar.addClass('layui-bg-green');
        }
        
        if (completed >= total && total > 0) {
          clearInterval(downloadMonitoringInterval);
          $('#task-status-text').text('æ‰€æœ‰ä»»å‹™å®Œæˆï¼');
          $('#total-download-speed').text('0.00 B/s'); // é‡ç½®ä¸‹è¼‰é€Ÿåº¦é¡¯ç¤º
          $('#concurrent-progress-section').hide();
          $('#download_control').hide();
          
          // ä¸‹è¼‰å®Œæˆå¾Œè‡ªå‹•æ›´æ–°é é¢è³‡æ–™
          console.log('æ‰€æœ‰ä¸‹è¼‰ä»»å‹™å®Œæˆï¼Œé–‹å§‹æ›´æ–°é é¢è³‡æ–™...');
          setTimeout(() => {
            loadDownloadHistory(currentPage); // é‡æ–°è¼‰å…¥ä¸‹è¼‰æ­·å²
            loadGroups(); // é‡æ–°è¼‰å…¥ç¾¤çµ„è³‡æ–™
            console.log('é é¢è³‡æ–™æ›´æ–°å®Œæˆ');
          }, 1000); // ç­‰å¾…1ç§’ç¢ºä¿å¾Œç«¯ç‹€æ…‹æ›´æ–°å®Œæˆ
          
          setTimeout(() => {
            $('#download-progress-area').hide();
          }, 3000);
        }
      }
      
      // ä¿å­˜ä¸Šæ¬¡æ›´æ–°çš„é€²åº¦ï¼Œé¿å…é »ç¹ç„¡æ•ˆæ›´æ–°
      let lastFileProgress = {};
      
      function updateConcurrentProgress(currentFiles) {
        const activeFiles = Object.values(currentFiles).filter(f => 
          f.total_bytes > 0 && f.downloaded_bytes < f.total_bytes
        );
        
        if (activeFiles.length > 0) {
          $('#concurrent-progress-section').show();
          $('#concurrent-count').text(activeFiles.length);
          
          const container = $('#concurrent-progress-container');
          
          // ç²å–ç¾æœ‰çš„é€²åº¦æ¢å®¹å™¨
          const existingContainers = {};
          container.find('[data-message-id]').each(function() {
            const messageId = $(this).data('message-id');
            existingContainers[messageId] = $(this);
          });
          
          activeFiles.forEach((file, index) => {
            const percentage = Math.round((file.downloaded_bytes / file.total_bytes) * 100);
            const downloadedMB = (file.downloaded_bytes / (1024 * 1024)).toFixed(2);
            const totalMB = (file.total_bytes / (1024 * 1024)).toFixed(2);
            const speedKB = Math.round(file.download_speed / 1024);
            
            const progressId = `concurrent-progress-${file.message_id}`;
            const fileKey = file.message_id.toString();
            
            // æª¢æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°ï¼ˆé¿å…ç„¡æ„ç¾©çš„é‡è¤‡æ›´æ–°ï¼‰
            const lastProgress = lastFileProgress[fileKey];
            const needsUpdate = !lastProgress || 
              Math.abs(lastProgress.percentage - percentage) >= 1 || // é€²åº¦è®ŠåŒ–è‡³å°‘1%
              Math.abs(lastProgress.speedKB - speedKB) > 10; // é€Ÿåº¦è®ŠåŒ–è¶…é10KB/s
            
            if (!needsUpdate && existingContainers[file.message_id]) {
              // è·³éæ›´æ–°ï¼Œä¿ç•™ç¾æœ‰é€²åº¦æ¢
              delete existingContainers[file.message_id];
              return;
            }
            
            // æ›´æ–°é€²åº¦è¨˜éŒ„
            lastFileProgress[fileKey] = { percentage, speedKB };
            
            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨æ­¤æª”æ¡ˆçš„é€²åº¦æ¢
            if (existingContainers[file.message_id]) {
              // æ›´æ–°ç¾æœ‰é€²åº¦æ¢ï¼Œé¿å…é‡æ–°å‰µå»º
              const existing = existingContainers[file.message_id];
              
              // ç²å–é€²åº¦æ¢å…ƒç´ ï¼ˆåªç²å–ä¸€æ¬¡ï¼‰
              const progressBar = existing.find('.layui-progress-bar');
              const progressFilter = `file-progress-${file.message_id}`;
              
              // æª¢æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°é¡è‰²ï¼ˆé¿å…ä¸å¿…è¦çš„DOMæ“ä½œï¼‰
              const currentPercentage = parseInt(progressBar.attr('lay-percent') || '0');
              const needsColorUpdate = (
                (currentPercentage <= 30 && percentage > 30) ||
                (currentPercentage > 30 && currentPercentage < 100 && percentage === 100) ||
                (currentPercentage > 30 && percentage <= 30)
              );
              
              // å¦‚æœéœ€è¦é¡è‰²æ›´æ–°ï¼Œå…ˆæ›´æ–°é¡è‰²
              if (needsColorUpdate) {
                progressBar.removeClass('layui-bg-red layui-bg-blue layui-bg-green');
                if (percentage > 30 && percentage < 100) {
                  progressBar.addClass('layui-bg-blue');
                } else if (percentage > 0 && percentage <= 30) {
                  progressBar.addClass('layui-bg-red');
                } else if (percentage == 100) {
                  progressBar.addClass('layui-bg-green');
                }
              }
              
              // ä½¿ç”¨ Layui çš„ element.progress æ–¹æ³•ä¾†ç²å¾—æµæš¢å‹•ç•«
              try {
                element.progress(progressFilter, percentage + '%');
                // å»¶é²æ›´æ–°æ–‡å­—ä¿¡æ¯ï¼Œè®“å‹•ç•«å…ˆå®Œæˆ
                setTimeout(() => {
                  existing.find('.downloaded-size').text(downloadedMB);
                  existing.find('.total-size').text(totalMB);
                  existing.find('.download-speed').text(speedKB);
                }, 50);
              } catch (e) {
                // å¦‚æœ Layui æ–¹æ³•å¤±æ•—ï¼Œä½¿ç”¨å¹³æ»‘çš„ CSS å‹•ç•«
                progressBar.css({
                  'width': percentage + '%',
                  'transition': 'width 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94)'
                });
                progressBar.attr('lay-percent', percentage + '%');
                
                // ç«‹å³æ›´æ–°æ–‡å­—ä¿¡æ¯ï¼ˆå› ç‚ºæ²’æœ‰Layuiå‹•ç•«ï¼‰
                existing.find('.downloaded-size').text(downloadedMB);
                existing.find('.total-size').text(totalMB);
                existing.find('.download-speed').text(speedKB);
              }
              
              delete existingContainers[file.message_id];
            } else {
              // å‰µå»ºæ–°çš„é€²åº¦æ¢
              const progressHtml = `
                <div data-message-id="${file.message_id}" style="
                  margin-bottom: 15px; 
                  padding: 15px; 
                  border: 2px solid #009688; 
                  border-radius: 8px; 
                  box-shadow: 0 2px 8px rgba(0,150,136,0.15);
                  background: linear-gradient(135deg, #f8fffe 0%, #f0fffe 100%);
                  position: relative;
                  overflow: hidden;
                ">
                  <div style="
                    position: absolute; 
                    top: 0; 
                    right: 0; 
                    background: #009688; 
                    color: white; 
                    padding: 2px 8px; 
                    font-size: 10px; 
                    border-bottom-left-radius: 6px;
                  ">
                    ID: ${file.message_id}
                  </div>
                  <div style="
                    font-size: 12px; 
                    font-weight: bold; 
                    margin-bottom: 8px; 
                    color: #00695c;
                    padding-right: 60px;
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                  ">
                    ğŸ“ ${file.name}
                  </div>
                  <div style="width: 80%; margin-bottom: 8px;">
                    <div class="layui-progress layui-progress-big" lay-showpercent="true" lay-filter="file-progress-${file.message_id}">
                      <div class="layui-progress-bar ${(percentage > 30 && percentage < 100) ? 'layui-bg-blue' : (percentage > 0 && percentage <= 30) ? 'layui-bg-red' : (percentage == 100) ? 'layui-bg-green' : ''}" lay-percent="${percentage}%"></div>
                    </div>
                  </div>
                  <div style="
                    font-size: 10px; 
                    color: #666; 
                    display: flex; 
                    justify-content: space-between;
                    align-items: center;
                  ">
                    <span>ğŸ“Š <span class="downloaded-size">${downloadedMB}</span> / <span class="total-size">${totalMB}</span> MB</span>
                    <span style="
                      background: #4caf50; 
                      color: white; 
                      padding: 2px 6px; 
                      border-radius: 10px; 
                      font-size: 9px;
                    ">
                      âš¡ <span class="download-speed">${speedKB}</span> KB/s
                    </span>
                  </div>
                </div>
              `;
              
              container.append(progressHtml);
              // é‡æ–°æ¸²æŸ“ Layui å…ƒç´ ï¼Œè®“æ–°çš„é€²åº¦æ¢å¯ä»¥ä½¿ç”¨ element.progress æ–¹æ³•
              element.render();
            }
          });
          
          // ç§»é™¤å·²å®Œæˆçš„é€²åº¦æ¢ä¸¦æ¸…ç†é€²åº¦è¨˜éŒ„
          Object.keys(existingContainers).forEach(messageId => {
            existingContainers[messageId].remove();
            // æ¸…ç†å°æ‡‰çš„é€²åº¦è¨˜éŒ„
            delete lastFileProgress[messageId];
          });
          
          console.log(`Concurrent progress: ${activeFiles.length} files downloading`);
        } else {
          $('#concurrent-progress-section').hide();
          // æ¸…ç†æ‰€æœ‰é€²åº¦è¨˜éŒ„
          lastFileProgress = {};
        }
      }
      
      // å…¼å®¹åŸä¾†çš„å–®ä¸€é€²åº¦æ¢å‡½æ•¸
      function updateFileProgress(fileName, downloadedBytes, totalBytes, downloadSpeed) {
        // é€™å€‹å‡½æ•¸ç¾åœ¨ä¸»è¦ç”¨æ–¼å…¼å®¹æ€§ï¼Œå¯¦éš›é¡¯ç¤ºç”± updateConcurrentProgress è™•ç†
        console.log(`File progress: ${fileName} - ${downloadedBytes}/${totalBytes} bytes @ ${downloadSpeed} B/s`);
      }
      
      // è¿½è¹¤ä¸‹è¼‰ç›£æ§ç‹€æ…‹
      let monitoringCount = 0;
      let lastCompletedCount = 0;
      
      function startDownloadMonitoring() {
        clearInterval(downloadMonitoringInterval);
        monitoringCount = 0;
        lastCompletedCount = 0;
        
        downloadMonitoringInterval = setInterval(() => {
          monitoringCount++;
          
          // ç²å–ä¸‹è¼‰é€²åº¦å’Œç¸½ä¸‹è¼‰é€Ÿåº¦
          $.ajax({
            url: '/get_download_progress',
            type: 'GET',
            success: function(response) {
              console.log('Progress response:', response);
              console.log(`Frontend Progress Debug: completed=${response.completed_count}, total=${response.total_count}, active=${response.active}`);
              if (response.success) {
                // æª¢æŸ¥æ˜¯å¦æœ‰æ–°çš„å®Œæˆé …ç›®
                if (response.completed_count > lastCompletedCount) {
                  console.log(`Progress updated: ${lastCompletedCount} -> ${response.completed_count}`);
                  lastCompletedCount = response.completed_count;
                  
                  // æ¯æœ‰æ–°çš„å®Œæˆé …ç›®æ™‚ï¼Œæ›´æ–°ä¸‹è¼‰æ­·å²
                  setTimeout(() => {
                    loadDownloadHistory(currentPage);
                    loadGroups();
                  }, 500);
                }
                
                // æ›´æ–°ä»»å‹™ç¸½é€²åº¦ï¼ˆåŒ…å«ä¸‹è¼‰é€Ÿåº¦ï¼Œç›´æ¥å¾responseä¸­ç²å–ï¼‰
                updateTaskProgress(
                  response.completed_count,
                  response.total_count,
                  response.status_text,
                  response.total_download_speed
                );
                
                // æ›´æ–°ä¸¦ç™¼æ–‡ä»¶é€²åº¦
                if (response.current_files && Object.keys(response.current_files).length > 0) {
                  updateConcurrentProgress(response.current_files);
                } else {
                  $('#concurrent-progress-section').hide();
                }
                
                // æ¯éš”10ç§’å®šæœŸæ›´æ–°é é¢è³‡æ–™ï¼ˆå¦‚æœä¸‹è¼‰é‚„åœ¨é€²è¡Œä¸­ï¼‰
                if (monitoringCount % 5 === 0 && response.active) {
                  console.log('å®šæœŸæ›´æ–°é é¢è³‡æ–™...');
                  loadDownloadHistory(currentPage);
                  loadGroups();
                }
              }
            },
            error: function() {
              console.log('Failed to get download progress');
            }
          });
        }, 2000); // æ¯2ç§’æª¢æŸ¥ä¸€æ¬¡
      }

      // ä¸‹è¼‰æ§åˆ¶ç›¸é—œå‡½æ•¸
      let downloadPaused = false;
      
      window.toggleDownloadState = function() {
        if (downloadPaused) {
          // æ¢å¾©ä¸‹è¼‰
          $.ajax({
            url: '/resume_download',
            type: 'POST',
            success: function(response) {
              if (response.success) {
                downloadPaused = false;
                $('#download_control_text').text('æš«åœä¸‹è¼‰');
                layer.msg('å·²æ¢å¾©ä¸‹è¼‰', {icon: 1});
                startDownloadMonitoring();
              }
            }
          });
        } else {
          // æš«åœä¸‹è¼‰
          $.ajax({
            url: '/pause_download',
            type: 'POST',
            success: function(response) {
              if (response.success) {
                downloadPaused = true;
                $('#download_control_text').text('æ¢å¾©ä¸‹è¼‰');
                layer.msg('å·²æš«åœä¸‹è¼‰', {icon: 1});
                clearInterval(downloadMonitoringInterval);
              }
            }
          });
        }
      }

      // å°‡å‡½æ•¸é™„åŠ åˆ°å…¨åŸŸä½œç”¨åŸŸ
      window.startAllDownloads = function() {
        console.log('startAllDownloads called');
        
        // é¦–å…ˆæª¢æŸ¥æ˜¯å¦æœ‰æ´»èºçš„ä¸‹è¼‰æœƒè©±
        $.ajax({
          url: '/get_download_progress',
          type: 'GET',
          success: function(response) {
            if (response.success && response.session && response.session.active) {
              layer.confirm('åµæ¸¬åˆ°æ­£åœ¨é€²è¡Œçš„ä¸‹è¼‰ä»»å‹™ï¼Œæ˜¯å¦è¦åœæ­¢ç•¶å‰ä»»å‹™ä¸¦é–‹å§‹æ–°çš„ä¸‹è¼‰ï¼Ÿ', {
                icon: 3,
                title: 'ä¸‹è¼‰è¡çª'
              }, function(index) {
                layer.close(index);
                proceedWithNewDownload();
              });
            } else {
              proceedWithNewDownload();
            }
          },
          error: function() {
            proceedWithNewDownload();
          }
        });
      }
      
      function proceedWithNewDownload() {
        console.log('proceedWithNewDownload called');
        
        // æª¢æŸ¥æ˜¯å¦æœ‰é¸ä¸­çš„é …ç›®
        let selectedTasks = [];
        $('.task-checkbox:checked').each(function() {
          let value = $(this).val().split(',');
          selectedTasks.push({
            chat_id: value[0],
            message_id: parseInt(value[1])
          });
        });
        
        if (selectedTasks.length === 0) {
          layer.confirm('æ²’æœ‰é¸æ“‡ä»»ä½•é …ç›®ã€‚æ˜¯å¦è¦è‡ªå‹•é¸æ“‡æ‰€æœ‰å¾…ä¸‹è¼‰çš„é …ç›®ï¼Ÿ', {
            icon: 3,
            title: 'æç¤º',
            btn: ['é¸æ“‡å¾…ä¸‹è¼‰é …ç›®', 'å–æ¶ˆ']
          }, function(index) {
            layer.close(index);
            selectPendingTasks();
            // å†æ¬¡æª¢æŸ¥æ˜¯å¦æœ‰é¸ä¸­é …ç›®
            setTimeout(() => {
              const nowSelected = $('.task-checkbox:checked').length;
              if (nowSelected > 0) {
                layer.confirm(`å·²é¸æ“‡ ${nowSelected} å€‹é …ç›®ï¼Œç¢ºå®šè¦é–‹å§‹ä¸‹è¼‰å—ï¼Ÿ`, {icon: 3, title: 'ç¢ºèªä¸‹è¼‰'}, function(confirmIndex) {
                  layer.close(confirmIndex);
                  // é‡æ–°èª¿ç”¨ä¸‹è¼‰å‡½æ•¸
                  let newSelectedTasks = [];
                  $('.task-checkbox:checked').each(function() {
                    let value = $(this).val().split(',');
                    newSelectedTasks.push({
                      chat_id: value[0],
                      message_id: parseInt(value[1])
                    });
                  });
                  startDownloadWithTasks(newSelectedTasks);
                });
              } else {
                layer.msg('æ²’æœ‰æ‰¾åˆ°å¾…ä¸‹è¼‰çš„é …ç›®', {icon: 2});
              }
            }, 100);
          });
          return;
        }
        
        startDownloadWithTasks(selectedTasks);
      }
      
      function startDownloadWithTasks(selectedTasks) {
        layer.confirm(`ç¢ºå®šè¦å•Ÿå‹•ä¸‹è¼‰ ${selectedTasks.length} å€‹é¸ä¸­é …ç›®å—ï¼Ÿ`, {icon: 3, title: 'ç¢ºèªå•Ÿå‹•'}, function(index) {
          console.log('Confirmation accepted, making AJAX request for selected tasks:', selectedTasks);
          $.ajax({
            url: '/start_selected_download',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({tasks: selectedTasks}),
            beforeSend: function() {
              console.log('Making request to /start_selected_download');
            },
            success: function(response) {
              console.log('Response received:', response);
              if (response.success) {
                layer.msg(response.message, {icon: 1});
                
                // é¡¯ç¤ºé€²åº¦æ¢ä¸¦é–‹å§‹ç›£æ§
                showDownloadProgress(selectedTasks.length);
                lastCompletedCount = 0; // é‡ç½®å®Œæˆè¨ˆæ•¸
                startDownloadMonitoring();
                // é¡¯ç¤ºä¸‹è¼‰æ§åˆ¶æŒ‰éˆ•
                $('#download_control').show();
                downloadPaused = false;
                $('#download_control_text').text('æš«åœä¸‹è¼‰');
                
                // é‡æ–°è¼‰å…¥ä¸‹è¼‰æ­·å²
                setTimeout(() => {
                  loadDownloadHistory(currentPage);
                }, 2000);
              } else {
                layer.msg('å•Ÿå‹•å¤±æ•—: ' + response.error, {icon: 2});
              }
            },
            error: function(xhr, status, error) {
              console.log('AJAX error:', xhr, status, error);
              layer.msg('å•Ÿå‹•è«‹æ±‚å¤±æ•—: ' + error, {icon: 2});
            }
          });
          layer.close(index);
        });
      }

      // è¡¨å–®æäº¤è™•ç†
      layui.form.on('submit(submit-download)', function(data) {
        const formData = data.field;
        
        if (!formData.chat_id || !formData.message_ids) {
          layer.msg("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š", {icon: 2});
          return false;
        }

        $.ajax({
          url: "/add_custom_download",
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify(formData),
          dataType: "json",
          success: function(result) {
            if (result.success) {
              layer.msg(result.message, {icon: 1});
              $("textarea[name='message_ids']").val(''); // æ¸…ç©ºè¼¸å…¥æ¡†
              loadGroups(); // é‡æ–°è¼‰å…¥ç¾¤çµ„è³‡æ–™
              loadDownloadHistory(1); // é‡æ–°è¼‰å…¥ä¸‹è¼‰æ­·å²ï¼Œå›åˆ°ç¬¬ä¸€é 
            } else {
              layer.msg("æ·»åŠ å¤±æ•—: " + result.error, {icon: 2});
            }
          },
          error: function() {
            layer.msg("è«‹æ±‚å¤±æ•—", {icon: 2});
          }
        });
        
        return false;
      });

      // ä¿®æ”¹åŸæœ‰çš„æ¨™ç±¤åˆ‡æ›ç›£è½ï¼Œæ·»åŠ è‡ªè¨‚ä¸‹è¼‰åŠŸèƒ½
      element.on('tab(telegram_media_downloader)', function(data) {
        if (data.index == 0) {
          update_download_list_int = self.setInterval(update_download_list, 1000);
        } else {
          clearInterval(update_download_list_int);
        }

        if (data.index != 1) {
          clearInterval(update_already_download_list_int);
        }

        if (data.index == 1) {
          update_already_download_list_int = self.setInterval(update_already_download_list, 1000);
        }

        // åˆ†é åˆ‡æ›äº‹ä»¶
        if (data.index == 0) {
          // ä¸‹è¼‰ç®¡ç†åˆ†é 
          loadGroups();
          loadDownloadHistory();
        } else if (data.index == 1) {
          // ç¾¤çµ„ç®¡ç†åˆ†é 
          loadGroups();
        }
      });

      // é é¢åŠ è¼‰æ™‚åˆå§‹åŒ–åŠŸèƒ½
      console.log('=== Page initialization starting ===');
      loadGroups();
      loadAllGroupOptions(); // è¼‰å…¥æ‰€æœ‰ç¾¤çµ„é¸é …ç”¨æ–¼ç¯©é¸
      loadDownloadHistory();
      console.log('=== Page initialization completed ===');
      
      // åˆå§‹åŒ–æœç´¢åŠŸèƒ½
      $('#group-search').on('input', function() {
        searchGroups();
      });
      
      // ä½¿ç”¨äº‹ä»¶å§”æ´¾è™•ç†ç¾¤çµ„ç®¡ç†æŒ‰éˆ•
      $(document).on('click', '.btn-edit-group', function() {
        const chatId = $(this).data('chat-id');
        const groupName = $(this).data('group-name');
        editGroupName(chatId, groupName);
      });
      
      $(document).on('click', '.btn-clear-group', function() {
        const chatId = $(this).data('chat-id');
        clearGroupIds(chatId);
      });
      
      
      $(document).on('click', '.btn-check-access', function() {
        const chatId = $(this).data('chat-id');
        checkGroupAccess(chatId);
      });
      
      $(document).on('click', '.btn-delete-group', function() {
        const chatId = $(this).data('chat-id');
        deleteGroup(chatId);
      });
      
      
      // æª¢æŸ¥æ˜¯å¦æœ‰æ´»èºçš„ä¸‹è¼‰æœƒè©±éœ€è¦æ¢å¾©
      checkAndResumeActiveSession();
      
      // ç¯©é¸ä¸‹æ‹‰é¸å–®ç›£è½äº‹ä»¶
      layui.form.on('select(group-filter)', function(data) {
        applyFilters();
      });
      
      layui.form.on('select(status-filter)', function(data) {
        applyFilters();
      });

    });
  </script>
</body>

</html>
