<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Telegram Media Downloader - 現代化媒體下載管理工具">
  <title>Telegram Media Downloader</title>
  
  <!-- Modern CSS Framework -->
  <link href="{{ url_for('static', filename='css/modern.css') }}" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/progress.css') }}" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/mobile.css') }}" rel="stylesheet">
  
  <!-- Icons -->
  <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.js"></script>
  
  <!-- Favicon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📥</text></svg>">
</head>

<body>
  <div class="app-container">
    <!-- App Header -->
    <header class="app-header">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="app-title">
            📡 Telegram Media Downloader
          </h1>
          <p class="app-subtitle">現代化媒體下載管理平台</p>
        </div>
        
        <div class="flex items-center gap-md">
          <!-- Session Status Indicator -->
          <div id="session-status-indicator" class="session-status">
            <span class="session-status-icon" id="session-status-icon">🔄</span>
            <span class="session-status-text" id="session-status-text">檢查連接中...</span>
          </div>
          
          <!-- Session Control Buttons -->
          <button id="reconnect-btn" class="glass-btn glass-btn-sm glass-btn-warning" style="display: none;" onclick="forceReconnect()">
            🔄 重新連接
          </button>
          
          <!-- Global Download Control -->
          <button id="global-download-control" class="glass-btn glass-btn-secondary" style="display: none;" onclick="toggleGlobalDownloadState()"
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="6" y="4" width="4" height="16"/>
              <rect x="14" y="4" width="4" height="16"/>
            </svg>
            <span id="global-download-text">暫停下載</span>
          </button>
          
          <!-- Version Info -->
          <div class="text-secondary" style="font-size: 12px;">
            版本 <span id="app-version">載入中...</span>
          </div>
        </div>
      </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="modern-tabs">
      <ul class="modern-tabs-nav">
        <li class="modern-tabs-item">
          <a href="#download-manager" class="modern-tabs-link active" data-tab="download-manager">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="7,10 12,15 17,10"/>
              <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            下載管理
          </a>
        </li>
        <li class="modern-tabs-item">
          <a href="#group-manager" class="modern-tabs-link" data-tab="group-manager">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="9" cy="7" r="4"/>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
            群組管理
          </a>
        </li>
      </ul>
    </nav>

    <div class="modern-tabs-content">
      <!-- Download Manager Tab -->
      <div id="download-manager" class="modern-tabs-panel active">
        <!-- Progress Summary Cards -->
        <div class="progress-summary">
          <div class="summary-card summary-card-pending">
            <div class="summary-card-value" id="summary-pending">0</div>
            <div class="summary-card-label">待下載</div>
          </div>
          <div class="summary-card summary-card-downloading">
            <div class="summary-card-value" id="summary-downloading">0</div>
            <div class="summary-card-label">下載中</div>
          </div>
          <div class="summary-card summary-card-completed">
            <div class="summary-card-value" id="summary-completed">0</div>
            <div class="summary-card-label">已完成</div>
          </div>
          <div class="summary-card summary-card-failed">
            <div class="summary-card-value" id="summary-failed">0</div>
            <div class="summary-card-label">失敗</div>
          </div>
        </div>

        <!-- Hidden elements for progress tracking (not visible but needed for data sync) -->
        <div style="display: none;">
          <span id="overall-completed">0</span>
          <span id="overall-total">0</span>
          <span id="overall-speed">0.00 B/s</span>
          <span id="overall-status-text">準備開始下載...</span>
          <div id="overall-progress-bar" style="width: 0%;">
            <div id="overall-progress-text">0%</div>
          </div>
          <span id="concurrent-count">0</span>
          <div id="concurrent-downloads-container"></div>
          <button id="pause-download-btn" style="display: none;"></button>
          <button id="resume-download-btn" style="display: none;"></button>
          <button id="cancel-download-btn" style="display: none;"></button>
        </div>

        <!-- Floating Download Progress Modal -->
        <div class="floating-progress-modal" id="floating-progress-modal" style="display: none;">
          <div class="floating-progress-header">
            <div class="floating-progress-title">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7,10 12,15 17,10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              下載進度
            </div>
            <div class="floating-progress-controls">
              <button class="floating-btn floating-btn-minimize" onclick="minimizeProgressModal()" title="最小化">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
              </button>
              <button class="floating-btn floating-btn-close" onclick="closeProgressModal()" title="關閉">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
            </div>
          </div>
          
          <div class="floating-progress-content">
            <div class="floating-progress-stats">
              <div class="floating-stat-compact">
                <div class="floating-stat-row">
                  <span class="floating-stat-item">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="9,11 12,14 22,4"/>
                    </svg>
                    已完成 <strong id="floating-completed-count">0</strong>
                  </span>
                  <span class="floating-stat-item">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"/>
                      <polyline points="12,6 12,12 16,14"/>
                    </svg>
                    剩餘 <strong id="floating-remaining-count">0</strong>
                  </span>
                </div>
                <div class="floating-stat-row">
                  <span class="floating-stat-speed">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="12" y1="15" x2="12" y2="3"/>
                      <polyline points="8,9 12,5 16,9"/>
                    </svg>
                    <strong id="floating-overall-speed">0.00 B/s</strong>
                  </span>
                </div>
              </div>
            </div>
            
            <div class="floating-progress-bar-container">
              <div class="floating-progress-bar">
                <div class="floating-progress-fill" id="floating-progress-bar" style="width: 0%;">
                  <div class="floating-progress-text" id="floating-progress-text">0%</div>
                </div>
              </div>
            </div>
            
            <div class="floating-progress-actions">
              <button class="floating-action-btn floating-btn-pause" onclick="pauseDownload()" id="floating-pause-btn">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="6" y="4" width="4" height="16"/>
                  <rect x="14" y="4" width="4" height="16"/>
                </svg>
                暫停
              </button>
              <button class="floating-action-btn floating-btn-resume" onclick="resumeDownload()" id="floating-resume-btn" style="display: none;">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polygon points="5,3 19,12 5,21 5,3"/>
                </svg>
                繼續
              </button>
              <button class="floating-action-btn floating-btn-cancel" onclick="cancelDownload()" id="floating-cancel-btn">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <line x1="15" y1="9" x2="9" y2="15"/>
                  <line x1="9" y1="9" x2="15" y2="15"/>
                </svg>
                取消
              </button>
            </div>
            
            <!-- Concurrent Downloads in Floating Modal -->
            <div class="floating-concurrent-section" id="floating-concurrent-section" style="display: none;">
              <div class="floating-concurrent-header">
                <h4 class="floating-concurrent-title">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="22,12 18,12 15,21 9,3 6,12 2,12"/>
                  </svg>
                  並發下載
                  <span class="floating-concurrent-badge" id="floating-concurrent-count">0</span>
                </h4>
                <button class="floating-btn floating-btn-toggle" onclick="toggleConcurrentSection()" id="concurrent-toggle-btn">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6,9 12,15 18,9"/>
                  </svg>
                </button>
              </div>
              <div class="floating-concurrent-content" id="floating-concurrent-content">
                <div class="floating-concurrent-grid" id="floating-concurrent-container">
                  <!-- Concurrent download items will be added here dynamically -->
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Minimized Progress Indicator -->
        <div class="minimized-progress-indicator" id="minimized-progress-indicator" style="display: none;" onclick="restoreProgressModal()">
          <div class="minimized-progress-content">
            <div class="minimized-progress-icon">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7,10 12,15 17,10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
            </div>
            <div class="minimized-progress-info">
              <span class="minimized-progress-label">下載中</span>
              <div class="minimized-progress-bar">
                <div class="minimized-progress-fill" id="minimized-progress-bar" style="width: 0%;"></div>
              </div>
              <span class="minimized-progress-percentage" id="minimized-progress-text">0%</span>
            </div>
          </div>
        </div>

        <!-- Batch Add Download IDs -->
        <div class="glass-card">
          <div class="glass-card-header">
            <h2 class="glass-card-title">批量新增下載任務</h2>
          </div>
          <div class="glass-card-body">
            <form class="glass-form" id="custom-download-form">
              <div class="glass-form-group">
                <label class="glass-form-label" for="group-select">選擇群組</label>
                <select name="chat_id" id="group-select" class="glass-form-select" required>
                  <option value="">請選擇群組...</option>
                </select>
              </div>
              
              <div class="glass-form-group">
                <label class="glass-form-label" for="message-ids">訊息 ID</label>
                <textarea name="message_ids" id="message-ids" class="glass-form-textarea" 
                  placeholder="請輸入訊息ID，支援以下格式：&#10;單個ID：123&#10;多個ID：123,456,789&#10;範圍：123-130&#10;混合：123,456-460,789" 
                  rows="6"></textarea>
                <div class="glass-form-help">
                  支援多種格式：單個ID、逗號分隔的多個ID、範圍（如123-130）或混合格式
                </div>
              </div>
              
              <div class="glass-form-group">
                <div class="flex gap-md">
                  <button type="submit" class="glass-btn glass-btn-primary flex-1">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                      <polyline points="7,10 12,15 17,10"/>
                      <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    立即加入佇列
                  </button>
                  <button type="reset" class="glass-btn glass-btn-secondary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M3 6h18"/>
                      <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                      <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                    </svg>
                    清空
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>

        <!-- Download History -->
        <div class="glass-card">
          <div class="glass-card-header">
            <h2 class="glass-card-title">下載歷史管理</h2>
            <div class="glass-card-actions">
              <div class="selected-count-display">
                <span class="selected-count-badge" id="selected-count-badge">
                  已選中 <strong id="selected-count">0</strong> 個項目
                </span>
              </div>
              <button class="glass-btn glass-btn-sm glass-btn-secondary" onclick="selectAllTasks()">
                全選
              </button>
              <button class="glass-btn glass-btn-sm glass-btn-secondary" onclick="deselectAllTasks()">
                取消全選
              </button>
              <button class="glass-btn glass-btn-sm glass-btn-warning" onclick="selectPendingTasks()">
                選擇待下載
              </button>
              <button class="glass-btn glass-btn-sm glass-btn-success" onclick="startSelectedDownloads()" id="start-download-btn">
                ▶ 啟動下載
              </button>
              <button class="glass-btn glass-btn-sm glass-btn-info" onclick="cleanDownloadedItems()">
                🧹 清理已下載
              </button>
              <button class="glass-btn glass-btn-sm glass-btn-danger" onclick="removeSelectedTasks()">
                🗑 移除選中
              </button>
            </div>
          </div>
          <div class="glass-card-body">
            <!-- Filter Toolbar -->
            <div class="history-filter-toolbar">
              <div class="filter-row">
                <div class="filter-controls">
                  <div class="filter-item">
                    <select id="group-filter" class="modern-form-select filter-select">
                      <option value="">🔍 全部群組</option>
                    </select>
                  </div>
                  <div class="filter-item">
                    <select id="status-filter" class="modern-form-select filter-select">
                      <option value="">📊 全部狀態</option>
                      <option value="pending">⏳ 待下載</option>
                      <option value="downloading">⚡ 下載中</option>
                      <option value="downloaded">✅ 已下載</option>
                      <option value="failed">❌ 失敗</option>
                    </select>
                  </div>
                  <div class="filter-item">
                    <button class="glass-btn glass-btn-sm glass-btn-secondary" onclick="clearFilters()">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 4v6h6"/>
                        <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
                      </svg>
                      清除篩選
                    </button>
                  </div>
                </div>
                <div class="filter-stats">
                  <span id="filtered-count" class="stats-badge">
                    📋 顯示：0 項目
                  </span>
                  <div class="pagination-controls">
                    <label for="items-per-page">每頁：</label>
                    <select id="items-per-page" class="modern-form-select items-per-page-select">
                      <option value="10">10</option>
                      <option value="20" selected>20</option>
                      <option value="30">30</option>
                      <option value="50">50</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <!-- Download History List -->
            <div class="glass-list" id="download-history-list">
              <!-- History items will be dynamically generated here -->
            </div>
            
            <!-- Pagination -->
            <div id="pagination-container" class="flex justify-center mt-lg">
              <!-- Pagination controls will be generated here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Group Manager Tab -->
      <div id="group-manager" class="modern-tabs-panel">
        <!-- Add Group Form -->
        <div class="glass-card">
          <div class="glass-card-header">
            <h2 class="glass-card-title">新增群組</h2>
          </div>
          <div class="glass-card-body">
            <form class="glass-form" id="add-group-form">
              <div class="modern-grid modern-grid-2 gap-md">
                <div class="glass-form-group">
                  <label class="glass-form-label" for="new-chat-id">群組 Chat ID</label>
                  <input type="text" name="chat_id" id="new-chat-id" class="glass-form-input" 
                    placeholder="輸入群組的 Chat ID" required>
                  <div class="glass-form-help">可在 Telegram 中獲取群組的唯一 ID</div>
                </div>
                
                <div class="glass-form-group">
                  <label class="glass-form-label" for="new-group-name">群組名稱</label>
                  <input type="text" name="name" id="new-group-name" class="glass-form-input" 
                    placeholder="輸入群組顯示名稱" required>
                  <div class="glass-form-help">用於在介面中顯示的友好名稱</div>
                </div>
              </div>
              
              <div class="glass-form-group">
                <div class="flex gap-md">
                  <button type="submit" class="glass-btn glass-btn-success">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <line x1="12" y1="5" x2="12" y2="19"/>
                      <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    新增群組
                  </button>
                  <button type="button" class="glass-btn glass-btn-secondary" onclick="checkGroupAccess()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M9 12l2 2 4-4"/>
                      <path d="M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9 9 4.03 9 9z"/>
                    </svg>
                    檢查群組權限
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>

        <!-- Groups List -->
        <div class="glass-card">
          <div class="glass-card-header">
            <h2 class="glass-card-title">群組管理</h2>
            <div class="glass-card-actions">
              <button class="glass-btn glass-btn-sm glass-btn-secondary" onclick="selectAllGroups()">全選</button>
              <button class="glass-btn glass-btn-sm glass-btn-danger" onclick="deleteSelectedGroups()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3,6 5,6 21,6"/>
                  <path d="M19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6M8,6V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"/>
                </svg>
                批量刪除
              </button>
              <button class="glass-btn glass-btn-sm glass-btn-warning" onclick="clearSelectedGroups()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 6h18"/>
                  <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                  <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                </svg>
                批量清空
              </button>
            </div>
          </div>
          <div class="glass-card-body">
            <div class="glass-list" id="groups-list">
              <!-- Groups will be dynamically loaded here -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScript Dependencies -->
  <script src="{{ url_for('static', filename='request/index.js') }}"></script>
  
  <!-- Modern JavaScript Implementation -->
  <script src="{{ url_for('static', filename='js/modern.js') }}"></script>
  
  <script>
    // Initialize icons
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }
    
    // Initialize the modern interface
    document.addEventListener('DOMContentLoaded', function() {
      ModernTelegramDownloader.init();
    });
  </script>
</body>
</html>