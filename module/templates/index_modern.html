<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Telegram Media Downloader - 現代化媒體下載管理工具">
  <title>Telegram Media Downloader</title>
  
  <!-- Modern CSS Framework -->
  <link href="{{ url_for('static', filename='css/modern.css') }}" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/progress.css') }}" rel="stylesheet">
  
  <!-- Icons -->
  <link href="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.js" rel="stylesheet">
  
  <!-- Favicon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📥</text></svg>">
</head>

<body>
  <div class="app-container">
    <!-- App Header -->
    <header class="app-header">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="app-title">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="7,10 12,15 17,10"/>
              <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            Telegram Media Downloader
          </h1>
          <p class="app-subtitle">現代化媒體下載管理平台</p>
        </div>
        
        <div class="flex items-center gap-md">
          <!-- Global Download Control -->
          <button id="global-download-control" class="modern-btn modern-btn-secondary" style="display: none;" onclick="toggleGlobalDownloadState()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="6" y="4" width="4" height="16"/>
              <rect x="14" y="4" width="4" height="16"/>
            </svg>
            <span id="global-download-text">暫停下載</span>
          </button>
          
          <!-- Version Info -->
          <div class="text-secondary" style="font-size: 12px;">
            版本 <span id="app-version">載入中...</span>
          </div>
        </div>
      </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="modern-tabs">
      <ul class="modern-tabs-nav">
        <li class="modern-tabs-item">
          <a href="#download-manager" class="modern-tabs-link active" data-tab="download-manager">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="7,10 12,15 17,10"/>
              <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            下載管理
          </a>
        </li>
        <li class="modern-tabs-item">
          <a href="#group-manager" class="modern-tabs-link" data-tab="group-manager">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="9" cy="7" r="4"/>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
            群組管理
          </a>
        </li>
      </ul>
    </nav>

    <div class="modern-tabs-content">
      <!-- Download Manager Tab -->
      <div id="download-manager" class="modern-tabs-panel active">
        <!-- Progress Summary Cards -->
        <div class="progress-summary">
          <div class="summary-card summary-card-pending">
            <div class="summary-card-value" id="summary-pending">0</div>
            <div class="summary-card-label">待下載</div>
          </div>
          <div class="summary-card summary-card-downloading">
            <div class="summary-card-value" id="summary-downloading">0</div>
            <div class="summary-card-label">下載中</div>
          </div>
          <div class="summary-card summary-card-completed">
            <div class="summary-card-value" id="summary-completed">0</div>
            <div class="summary-card-label">已完成</div>
          </div>
          <div class="summary-card summary-card-failed">
            <div class="summary-card-value" id="summary-failed">0</div>
            <div class="summary-card-label">失敗</div>
          </div>
        </div>

        <!-- Download Control Panel -->
        <div class="modern-card">
          <div class="modern-card-header">
            <h2 class="modern-card-title">下載控制中心</h2>
            <div class="modern-card-actions">
              <button class="modern-btn modern-btn-success" onclick="startSelectedDownloads()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polygon points="5,3 19,12 5,21 5,3"/>
                </svg>
                啟動選中項目
              </button>
            </div>
          </div>
          <div class="modern-card-body">
            <p class="text-secondary mb-lg">選擇要下載的項目，然後點擊「啟動選中項目」來開始下載</p>
            
            <!-- Download Progress Area -->
            <div id="download-progress-area" class="download-progress-container" style="display: none;">
              <!-- Overall Progress -->
              <div class="overall-progress-section">
                <div class="overall-progress-header">
                  <h3 style="margin: 0; font-size: 16px; font-weight: 600;">
                    總下載進度 - <span id="overall-status-text">準備開始下載...</span>
                  </h3>
                  <div class="overall-progress-stats">
                    <div class="progress-stat">
                      <svg class="progress-stat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 12l2 2 4-4"/>
                        <path d="M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9 9 4.03 9 9z"/>
                      </svg>
                      已完成 <span class="progress-stat-value" id="overall-completed">0</span> / <span class="progress-stat-value" id="overall-total">0</span> 個任務
                    </div>
                    <div class="progress-stat">
                      <svg class="progress-stat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7,10 12,15 17,10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                      </svg>
                      <span class="progress-stat-value" id="overall-speed">0.00 B/s</span>
                    </div>
                  </div>
                </div>
                
                <div class="modern-progress-enhanced">
                  <div class="modern-progress-bar-enhanced" id="overall-progress-bar" style="width: 0%;">
                    <div class="progress-text" id="overall-progress-text">0%</div>
                  </div>
                </div>
              </div>

              <!-- Concurrent Downloads -->
              <div id="concurrent-downloads-section" class="concurrent-downloads-section" style="display: none;">
                <div class="concurrent-downloads-header">
                  <h3 class="concurrent-downloads-title">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="22,12 18,12 15,21 9,3 6,12 2,12"/>
                    </svg>
                    並發下載進度
                    <span class="concurrent-count-badge" id="concurrent-count">0</span>
                  </h3>
                </div>
                <div class="concurrent-downloads-grid" id="concurrent-downloads-container">
                  <!-- Concurrent download items will be dynamically generated here -->
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Batch Add Download IDs -->
        <div class="modern-card">
          <div class="modern-card-header">
            <h2 class="modern-card-title">批量新增下載任務</h2>
          </div>
          <div class="modern-card-body">
            <form class="modern-form" id="custom-download-form">
              <div class="modern-form-group">
                <label class="modern-form-label" for="group-select">選擇群組</label>
                <select name="chat_id" id="group-select" class="modern-form-select" required>
                  <option value="">請選擇群組...</option>
                </select>
              </div>
              
              <div class="modern-form-group">
                <label class="modern-form-label" for="message-ids">訊息 ID</label>
                <textarea name="message_ids" id="message-ids" class="modern-form-textarea" 
                  placeholder="請輸入訊息ID，支援以下格式：&#10;單個ID：123&#10;多個ID：123,456,789&#10;範圍：123-130&#10;混合：123,456-460,789" 
                  rows="6"></textarea>
                <div class="modern-form-help">
                  支援多種格式：單個ID、逗號分隔的多個ID、範圍（如123-130）或混合格式
                </div>
              </div>
              
              <div class="modern-form-group">
                <div class="flex gap-md">
                  <button type="submit" class="modern-btn modern-btn-primary flex-1">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                      <polyline points="7,10 12,15 17,10"/>
                      <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    立即加入佇列
                  </button>
                  <button type="reset" class="modern-btn modern-btn-secondary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M3 6h18"/>
                      <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                      <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                    </svg>
                    清空
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>

        <!-- Download History -->
        <div class="modern-card">
          <div class="modern-card-header">
            <h2 class="modern-card-title">下載歷史管理</h2>
            <div class="modern-card-actions">
              <button class="modern-btn modern-btn-sm modern-btn-secondary" onclick="selectAllTasks()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="9,11 12,14 22,4"/>
                  <path d="M21,12v7a2,2 0 0,1 -2,2H5a2,2 0 0,1 -2,-2V5a2,2 0 0,1 2,-2h11"/>
                </svg>
                全選
              </button>
              <button class="modern-btn modern-btn-sm modern-btn-warning" onclick="selectPendingTasks()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <polyline points="12,6 12,12 16,14"/>
                </svg>
                選擇待下載
              </button>
              <button class="modern-btn modern-btn-sm modern-btn-secondary" onclick="deselectAllTasks()">取消全選</button>
              <button class="modern-btn modern-btn-sm modern-btn-success" onclick="cleanDownloadedItems()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 6h18"/>
                  <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                  <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                </svg>
                清理已下載
              </button>
              <button class="modern-btn modern-btn-sm modern-btn-danger" onclick="removeSelectedTasks()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3,6 5,6 21,6"/>
                  <path d="M19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6M8,6V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"/>
                  <line x1="10" y1="11" x2="10" y2="17"/>
                  <line x1="14" y1="11" x2="14" y2="17"/>
                </svg>
                移除選中
              </button>
            </div>
          </div>
          <div class="modern-card-body">
            <!-- Filter Controls -->
            <div class="modern-card mb-lg" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
              <div class="modern-card-body">
                <h3 class="mb-md" style="color: white; margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="M21 21l-4.35-4.35"/>
                  </svg>
                  智能篩選控制台
                </h3>
                
                <div class="modern-grid modern-grid-3 gap-md">
                  <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); border-radius: 8px; padding: 16px;">
                    <label style="color: rgba(255,255,255,0.9); font-size: 13px; margin-bottom: 8px; display: block; font-weight: 500;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                      </svg>
                      群組篩選
                    </label>
                    <select id="group-filter" class="modern-form-select" style="background: rgba(255,255,255,0.9); border: 1px solid rgba(255,255,255,0.3);">
                      <option value="">🔍 全部群組</option>
                    </select>
                  </div>
                  
                  <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); border-radius: 8px; padding: 16px;">
                    <label style="color: rgba(255,255,255,0.9); font-size: 13px; margin-bottom: 8px; display: block; font-weight: 500;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                        <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/>
                        <line x1="4" y1="22" x2="4" y2="15"/>
                      </svg>
                      狀態篩選
                    </label>
                    <select id="status-filter" class="modern-form-select" style="background: rgba(255,255,255,0.9); border: 1px solid rgba(255,255,255,0.3);">
                      <option value="">📊 全部狀態</option>
                      <option value="pending">⏳ 待下載</option>
                      <option value="downloading">⚡ 下載中</option>
                      <option value="downloaded">✅ 已下載</option>
                      <option value="failed">❌ 失敗</option>
                    </select>
                  </div>
                  
                  <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); border-radius: 8px; padding: 16px;">
                    <label style="color: rgba(255,255,255,0.9); font-size: 13px; margin-bottom: 8px; display: block; font-weight: 500;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                        <polyline points="9,11 12,14 22,4"/>
                        <path d="M21,12v7a2,2 0 0,1 -2,2H5a2,2 0 0,1 -2,-2V5a2,2 0 0,1 2,-2h11"/>
                      </svg>
                      操作
                    </label>
                    <div class="flex gap-sm">
                      <button class="modern-btn modern-btn-primary" onclick="applyFilters()" style="flex: 1; background: rgba(0, 122, 255, 0.8); border: none;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <circle cx="11" cy="11" r="8"/>
                          <path d="M21 21l-4.35-4.35"/>
                        </svg>
                        篩選
                      </button>
                      <button class="modern-btn modern-btn-secondary" onclick="clearFilters()" style="flex: 1; background: rgba(255,255,255,0.2); border: none; color: white;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M1 4v6h6"/>
                          <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
                        </svg>
                        清除
                      </button>
                    </div>
                  </div>
                </div>
                
                <div class="text-center mt-lg" style="padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.2);">
                  <span id="filtered-count" style="color: white; background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; backdrop-filter: blur(5px); font-size: 14px;">
                    📋 顯示：0 項目
                  </span>
                </div>
              </div>
            </div>

            <!-- Download History List -->
            <div class="modern-list" id="download-history-list">
              <!-- History items will be dynamically generated here -->
            </div>
            
            <!-- Pagination -->
            <div id="pagination-container" class="flex justify-center mt-lg">
              <!-- Pagination controls will be generated here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Group Manager Tab -->
      <div id="group-manager" class="modern-tabs-panel">
        <!-- Add Group Form -->
        <div class="modern-card">
          <div class="modern-card-header">
            <h2 class="modern-card-title">新增群組</h2>
          </div>
          <div class="modern-card-body">
            <form class="modern-form" id="add-group-form">
              <div class="modern-grid modern-grid-2 gap-md">
                <div class="modern-form-group">
                  <label class="modern-form-label" for="new-chat-id">群組 Chat ID</label>
                  <input type="text" name="chat_id" id="new-chat-id" class="modern-form-input" 
                    placeholder="輸入群組的 Chat ID" required>
                  <div class="modern-form-help">可在 Telegram 中獲取群組的唯一 ID</div>
                </div>
                
                <div class="modern-form-group">
                  <label class="modern-form-label" for="new-group-name">群組名稱</label>
                  <input type="text" name="name" id="new-group-name" class="modern-form-input" 
                    placeholder="輸入群組顯示名稱" required>
                  <div class="modern-form-help">用於在介面中顯示的友好名稱</div>
                </div>
              </div>
              
              <div class="modern-form-group">
                <div class="flex gap-md">
                  <button type="submit" class="modern-btn modern-btn-success">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <line x1="12" y1="5" x2="12" y2="19"/>
                      <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    新增群組
                  </button>
                  <button type="button" class="modern-btn modern-btn-secondary" onclick="checkGroupAccess()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M9 12l2 2 4-4"/>
                      <path d="M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9 9 4.03 9 9z"/>
                    </svg>
                    檢查群組權限
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>

        <!-- Groups List -->
        <div class="modern-card">
          <div class="modern-card-header">
            <h2 class="modern-card-title">群組管理</h2>
            <div class="modern-card-actions">
              <button class="modern-btn modern-btn-sm modern-btn-secondary" onclick="selectAllGroups()">全選</button>
              <button class="modern-btn modern-btn-sm modern-btn-danger" onclick="deleteSelectedGroups()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3,6 5,6 21,6"/>
                  <path d="M19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6M8,6V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"/>
                </svg>
                批量刪除
              </button>
              <button class="modern-btn modern-btn-sm modern-btn-warning" onclick="clearSelectedGroups()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 6h18"/>
                  <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                  <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                </svg>
                批量清空
              </button>
            </div>
          </div>
          <div class="modern-card-body">
            <div class="modern-list" id="groups-list">
              <!-- Groups will be dynamically loaded here -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScript Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.js"></script>
  <script src="{{ url_for('static', filename='aes/crypto-js-master/core.js') }}"></script>
  <script src="{{ url_for('static', filename='aes/crypto-js-master/enc-base64.js') }}"></script>
  <script src="{{ url_for('static', filename='aes/crypto-js-master/aes.js') }}"></script>
  <script src="{{ url_for('static', filename='request/index.js') }}"></script>
  
  <!-- Modern JavaScript Implementation -->
  <script src="{{ url_for('static', filename='js/modern.js') }}"></script>
  
  <script>
    // Initialize icons
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }
    
    // Initialize the modern interface
    document.addEventListener('DOMContentLoaded', function() {
      ModernTelegramDownloader.init();
    });
  </script>
</body>
</html>