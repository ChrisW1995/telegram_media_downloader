<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Message Downloader 登入</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/modern.css') }}" rel="stylesheet">
    <style>
        /* Apple-inspired Design with Liquid Glass - Dark Theme */
        body {
            background:
                /* Dark Apple-style subtle orbs */
                radial-gradient(ellipse 400px 200px at 20% 30%, rgba(70, 130, 180, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse 350px 180px at 80% 20%, rgba(100, 149, 237, 0.12) 0%, transparent 45%),
                radial-gradient(ellipse 300px 150px at 50% 80%, rgba(123, 104, 238, 0.1) 0%, transparent 40%),
                /* Dark base gradient */
                linear-gradient(135deg, #1a1a1a 0%, #2c2c2e 50%, #1c1c1e 100%);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
            font-weight: 400;
            letter-spacing: -0.005em;
            margin: 0;
            padding: 0;
            background-attachment: fixed;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Apple Typography System - Dark Theme */
        :root {
            --apple-label-primary: rgba(255, 255, 255, 0.92);
            --apple-label-secondary: rgba(235, 235, 245, 0.6);
            --apple-label-tertiary: rgba(235, 235, 245, 0.7);
            --apple-blue: #0A84FF;
            --apple-green: #30D158;
            --apple-red: #FF453A;
        }

        .login-container {
            max-width: 400px;
            width: 100%;
            padding: 20px;
        }

        .login-card {
            background:
                linear-gradient(135deg,
                    rgba(255, 255, 255, 0.25) 0%,
                    rgba(255, 255, 255, 0.15) 50%,
                    rgba(255, 255, 255, 0.2) 100%);
            backdrop-filter: blur(40px) saturate(180%) brightness(1.05);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 24px;
            padding: 40px;
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.1),
                0 2px 8px rgba(0, 0, 0, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
        }

        .login-title {
            color: var(--apple-label-primary);
            font-size: 32px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 8px;
            letter-spacing: -0.02em;
        }

        .login-subtitle {
            color: var(--apple-label-secondary);
            font-size: 16px;
            text-align: center;
            margin-bottom: 40px;
        }

        .phone-input-group {
            position: relative;
            margin-bottom: 20px;
        }

        .country-code {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: #1d1d1f;
            font-weight: 600;
            font-size: 17px;
            z-index: 2;
        }

        .form-control {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px) saturate(120%);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 16px 18px;
            color: #1d1d1f;
            font-size: 17px;
            font-weight: 400;
            transition: all 0.3s ease;
            width: 100%;
            box-sizing: border-box;
            box-shadow:
                0 2px 8px rgba(0, 0, 0, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }

        .form-control:focus {
            background: rgba(255, 255, 255, 0.95);
            border-color: var(--apple-blue);
            box-shadow:
                0 0 0 3px rgba(0, 122, 255, 0.15),
                0 4px 20px rgba(0, 122, 255, 0.2);
            color: #1d1d1f;
            outline: none;
        }

        .form-control::placeholder {
            color: var(--apple-label-tertiary);
            font-weight: 400;
        }

        #phone {
            padding-left: 65px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #007AFF 0%, #5AC8FA 100%);
            border: none;
            border-radius: 12px;
            padding: 16px 32px;
            font-weight: 600;
            font-size: 17px;
            color: #FFFFFF;
            letter-spacing: -0.01em;
            transition: all 0.3s ease;
            box-shadow:
                0 4px 16px rgba(0, 122, 255, 0.3),
                0 2px 4px rgba(0, 0, 0, 0.1);
            width: 100%;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #0056CC 0%, #4A9EE7 100%);
            transform: translateY(-2px);
            box-shadow:
                0 6px 20px rgba(0, 122, 255, 0.4),
                0 4px 8px rgba(0, 0, 0, 0.15);
            color: #FFFFFF;
        }

        .btn-primary:active {
            transform: translateY(0) scale(0.96);
            box-shadow:
                0 2px 8px rgba(0, 122, 255, 0.3),
                0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 16px 32px;
            font-weight: 600;
            font-size: 17px;
            color: var(--apple-blue);
            letter-spacing: -0.01em;
            transition: all 0.3s ease;
            box-shadow:
                0 2px 8px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            width: 100%;
            margin-top: 12px;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.95);
            transform: translateY(-2px);
            box-shadow:
                0 4px 12px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            color: #0056CC;
        }

        .divider {
            text-align: center;
            margin: 30px 0;
            position: relative;
            color: var(--apple-label-secondary);
            font-size: 14px;
        }

        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--apple-label-tertiary);
            z-index: 1;
        }

        .divider span {
            background: rgba(255, 255, 255, 0.9);
            padding: 0 16px;
            position: relative;
            z-index: 2;
        }

        .alert {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .alert-success {
            border-color: var(--apple-green);
            color: var(--apple-green);
        }

        .alert-danger {
            border-color: var(--apple-red);
            color: var(--apple-red);
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
        }

        .qr-container {
            text-align: center;
            padding: 20px;
        }

        #qr-code {
            margin: 20px auto;
            display: inline-block;
            min-height: 200px;
        }

        #qr-code.has-qr {
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .spinner-border {
            width: 1.5rem;
            height: 1.5rem;
            border-width: 2px;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="login-card">
            <h1 class="login-title">Message Downloader</h1>
            <p class="login-subtitle">請使用 Telegram 帳號登入</p>

            <div id="alert-container"></div>

            <!-- 步驟 2: 電話號碼輸入 -->
            <div id="step-2" class="step active">
                <div class="phone-input-group">
                    <span class="country-code">+886</span>
                    <input type="text" id="phone" class="form-control" placeholder="9xxxxxxxx" pattern="[0-9]{9}" maxlength="9">
                </div>
                <button id="send-code-btn" class="btn btn-primary">
                    發送驗證碼
                </button>
                <div class="divider">
                    <span>或</span>
                </div>
                <button id="qr-login-from-phone-btn" class="btn btn-secondary">
                    <i class="fas fa-qrcode me-2"></i>使用 QR Code 登入
                </button>
            </div>

            <!-- 步驟 3: 驗證碼輸入 -->
            <div id="step-3" class="step">
                <input type="text" id="verification-code" class="form-control mb-3" placeholder="請輸入驗證碼" maxlength="5">
                <button id="verify-code-btn" class="btn btn-primary">
                    驗證
                </button>
                <button id="back-to-phone-btn" class="btn btn-secondary">
                    返回
                </button>
            </div>

            <!-- 步驟 4: 兩步驟驗證密碼 -->
            <div id="step-4" class="step">
                <input type="password" id="two-factor-password" class="form-control mb-3" placeholder="請輸入兩步驟驗證密碼">
                <button id="verify-password-btn" class="btn btn-primary">
                    驗證密碼
                </button>
            </div>

            <!-- 步驟 5: QR Code 登入 -->
            <div id="step-5" class="step">
                <div class="qr-container">
                    <h5 class="mb-3">掃描 QR Code 登入</h5>
                    <p class="text-muted mb-3">使用 Telegram 應用程式掃描下方 QR Code</p>
                    <div id="qr-code"></div>
                    <div id="qr-status" class="mt-3">
                        <div class="spinner-border text-primary me-2"></div>
                        正在生成 QR Code...
                    </div>
                    <button id="refresh-qr-btn" class="btn btn-primary mt-3" style="display: none;">
                        <i class="fas fa-sync-alt me-2"></i>重新生成 QR Code
                    </button>
                </div>
                <button id="back-to-method-from-qr-btn" class="btn btn-secondary">
                    返回選擇登入方式
                </button>
            </div>

            <!-- 步驟 6: 登入成功 -->
            <div id="step-6" class="step">
                <div class="text-center">
                    <i class="fas fa-check-circle text-success mb-3" style="font-size: 3rem;"></i>
                    <h5 class="mb-3">登入成功！</h5>
                    <p class="text-muted">正在跳轉到 Message Downloader...</p>
                    <div class="spinner-border text-primary mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <script>
        let currentStep = 2;
        let sessionKey = '';
        let qrLoginInterval = null;

        function showStep(step) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById(`step-${step}`).classList.add('active');
            currentStep = step;
        }

        function showAlert(message, type = 'danger') {
            const alertContainer = document.getElementById('alert-container');
            alertContainer.innerHTML = `
                <div class="alert alert-${type}">
                    ${message}
                </div>
            `;
            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 5000);
        }

        // QR Code 登入按鈕
        document.getElementById('qr-login-from-phone-btn').addEventListener('click', () => {
            showStep(5);
            startQRLogin();
        });

        // QR Code 刷新按鈕
        document.getElementById('refresh-qr-btn').addEventListener('click', () => {
            // 顯示載入動畫
            document.getElementById('qr-status').innerHTML = '<div class="spinner-border text-primary me-2"></div>正在重新生成 QR Code...';
            document.getElementById('refresh-qr-btn').style.display = 'none';

            // 清除舊的 QR Code
            const qrContainer = document.getElementById('qr-code');
            qrContainer.innerHTML = '';
            qrContainer.classList.remove('has-qr');

            // 重新開始 QR 登入
            startQRLogin();
        });

        document.getElementById('back-to-method-from-qr-btn').addEventListener('click', () => {
            if (qrLoginInterval) {
                clearInterval(qrLoginInterval);
                qrLoginInterval = null;
            }
            showStep(2);
        });

        document.getElementById('back-to-phone-btn').addEventListener('click', () => {
            showStep(2);
        });

        // 電話號碼輸入處理
        document.getElementById('phone').addEventListener('input', function(e) {
            // 只允許數字
            this.value = this.value.replace(/[^0-9]/g, '');

            // 限制長度為9位數
            if (this.value.length > 9) {
                this.value = this.value.slice(0, 9);
            }
        });

        // 發送驗證碼
        document.getElementById('send-code-btn').addEventListener('click', async () => {
            const phone = document.getElementById('phone').value;
            const sendButton = document.getElementById('send-code-btn');

            if (!phone || phone.length !== 9) {
                showAlert('請輸入正確的電話號碼（9位數字）');
                return;
            }

            const fullPhone = '+886' + phone;

            // 防止重複提交
            if (sendButton.disabled) {
                return;
            }

            // 禁用按鈕並顯示載入狀態
            sendButton.disabled = true;
            const originalText = sendButton.innerHTML;
            sendButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>發送中...';

            try {
                const response = await fetch('/api/auth/send_code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        phone_number: fullPhone
                    })
                });

                const result = await response.json();

                if (result.success) {
                    sessionKey = result.session_key;
                    showStep(3);
                    showAlert('驗證碼已發送到您的 Telegram', 'success');
                } else {
                    showAlert(result.error || '發送驗證碼失敗');
                }
            } catch (error) {
                showAlert('網路錯誤，請稍後再試');
            } finally {
                // 恢復按鈕狀態
                sendButton.disabled = false;
                sendButton.innerHTML = originalText;
            }
        });

        // 驗證驗證碼
        document.getElementById('verify-code-btn').addEventListener('click', async () => {
            const code = document.getElementById('verification-code').value;
            const verifyButton = document.getElementById('verify-code-btn');

            if (!code) {
                showAlert('請輸入驗證碼');
                return;
            }

            // 防止重複提交
            if (verifyButton.disabled) {
                return;
            }

            // 禁用按鈕並顯示載入狀態
            verifyButton.disabled = true;
            const originalText = verifyButton.innerHTML;
            verifyButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>驗證中...';

            try {
                const response = await fetch('/api/auth/verify_code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_key: sessionKey,
                        verification_code: code
                    })
                });

                const result = await response.json();

                if (result.success) {
                    if (result.requires_password) {
                        showStep(4);
                        showAlert('請輸入兩步驟驗證密碼', 'success');
                    } else {
                        // 登入成功
                        showStep(6);
                        setTimeout(() => {
                            window.location.href = '/message_downloader';
                        }, 2000);
                    }
                } else {
                    showAlert(result.error || '驗證碼錯誤');
                }
            } catch (error) {
                showAlert('網路錯誤，請稍後再試');
            } finally {
                // 恢復按鈕狀態
                verifyButton.disabled = false;
                verifyButton.innerHTML = originalText;
            }
        });

        // 驗證兩步驟密碼
        document.getElementById('verify-password-btn').addEventListener('click', async () => {
            const password = document.getElementById('two-factor-password').value;
            const passwordButton = document.getElementById('verify-password-btn');

            if (!password) {
                showAlert('請輸入兩步驟驗證密碼');
                return;
            }

            // 防止重複提交
            if (passwordButton.disabled) {
                return;
            }

            // 禁用按鈕並顯示載入狀態
            passwordButton.disabled = true;
            const originalText = passwordButton.innerHTML;
            passwordButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>驗證中...';

            try {
                const response = await fetch('/api/auth/verify_password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_key: sessionKey,
                        password: password
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // 登入成功
                    showStep(6);
                    setTimeout(() => {
                        window.location.href = '/message_downloader';
                    }, 2000);
                } else {
                    showAlert(result.error || '密碼錯誤');
                }
            } catch (error) {
                showAlert('網路錯誤，請稍後再試');
            } finally {
                // 恢復按鈕狀態
                passwordButton.disabled = false;
                passwordButton.innerHTML = originalText;
            }
        });

        // QR Code 登入
        async function startQRLogin() {
            try {
                const response = await fetch('/api/auth/qr_login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();

                if (result.success) {
                    sessionKey = result.session_key;

                    // 生成 QR Code
                    const qrContainer = document.getElementById('qr-code');
                    qrContainer.innerHTML = '';
                    qrContainer.classList.add('has-qr');

                    // 使用 qrcode-generator 庫
                    const qr = qrcode(0, 'M');
                    qr.addData(result.qr_token);
                    qr.make();

                    const qrImg = document.createElement('img');
                    qrImg.src = qr.createDataURL(4, 2);
                    qrImg.style.width = '200px';
                    qrImg.style.height = '200px';
                    qrContainer.appendChild(qrImg);

                    document.getElementById('qr-status').innerHTML = '請使用 Telegram 掃描 QR Code';
                    document.getElementById('refresh-qr-btn').style.display = 'none';

                    // 開始輪詢登入狀態
                    qrLoginInterval = setInterval(checkQRLoginStatus, 2000);
                } else {
                    showAlert(result.error || '無法生成 QR Code');
                }
            } catch (error) {
                showAlert('網路錯誤，請稍後再試');
            }
        }

        async function checkQRLoginStatus() {
            try {
                console.log('Checking QR login status...', sessionKey);
                const response = await fetch('/api/auth/check_qr_status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_key: sessionKey
                    })
                });

                const result = await response.json();
                console.log('QR status result:', result);

                if (result.success && result.authenticated) {
                    console.log('🎉 QR login authenticated! Redirecting...');
                    clearInterval(qrLoginInterval);
                    showStep(6);
                    setTimeout(() => {
                        window.location.href = '/message_downloader';
                    }, 2000);
                } else if (result.expired) {
                    clearInterval(qrLoginInterval);
                    showAlert('QR Code 已過期，請重新生成');
                    document.getElementById('qr-status').innerHTML = 'QR Code 已過期';
                    document.getElementById('refresh-qr-btn').style.display = 'inline-block';
                    // 清除 QR Code 容器
                    const qrContainer = document.getElementById('qr-code');
                    qrContainer.innerHTML = '';
                    qrContainer.classList.remove('has-qr');
                }
            } catch (error) {
                console.error('檢查 QR 登入狀態失敗:', error);
            }
        }

        // Enter 鍵處理
        document.getElementById('phone').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('send-code-btn').click();
            }
        });

        document.getElementById('verification-code').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('verify-code-btn').click();
            }
        });

        document.getElementById('two-factor-password').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('verify-password-btn').click();
            }
        });
    </script>
</body>
</html>