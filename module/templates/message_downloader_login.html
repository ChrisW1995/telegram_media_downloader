<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Message Downloader ç™»å…¥</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/modern.css') }}" rel="stylesheet">
    <style>
        /* Apple-inspired Design with Liquid Glass - Dark Theme */
        body {
            background:
                /* Dark Apple-style subtle orbs */
                radial-gradient(ellipse 400px 200px at 20% 30%, rgba(70, 130, 180, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse 350px 180px at 80% 20%, rgba(100, 149, 237, 0.12) 0%, transparent 45%),
                radial-gradient(ellipse 300px 150px at 50% 80%, rgba(123, 104, 238, 0.1) 0%, transparent 40%),
                /* Dark base gradient */
                linear-gradient(135deg, #1a1a1a 0%, #2c2c2e 50%, #1c1c1e 100%);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
            font-weight: 400;
            letter-spacing: -0.005em;
            margin: 0;
            padding: 0;
            background-attachment: fixed;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Apple Typography System - Dark Theme */
        :root {
            --apple-label-primary: rgba(255, 255, 255, 0.92);
            --apple-label-secondary: rgba(235, 235, 245, 0.6);
            --apple-label-tertiary: rgba(235, 235, 245, 0.7);
            --apple-blue: #0A84FF;
            --apple-green: #30D158;
            --apple-red: #FF453A;
        }

        .login-container {
            max-width: 400px;
            width: 100%;
            padding: 20px;
        }

        .login-card {
            background:
                linear-gradient(135deg,
                    rgba(255, 255, 255, 0.25) 0%,
                    rgba(255, 255, 255, 0.15) 50%,
                    rgba(255, 255, 255, 0.2) 100%);
            backdrop-filter: blur(40px) saturate(180%) brightness(1.05);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 24px;
            padding: 40px;
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.1),
                0 2px 8px rgba(0, 0, 0, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
        }

        .login-title {
            color: var(--apple-label-primary);
            font-size: 32px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 8px;
            letter-spacing: -0.02em;
        }

        .login-subtitle {
            color: var(--apple-label-secondary);
            font-size: 16px;
            text-align: center;
            margin-bottom: 40px;
        }

        .phone-input-group {
            position: relative;
            margin-bottom: 20px;
        }

        .country-code {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: #1d1d1f;
            font-weight: 600;
            font-size: 17px;
            z-index: 2;
        }

        .form-control {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px) saturate(120%);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 16px 18px;
            color: #1d1d1f;
            font-size: 17px;
            font-weight: 400;
            transition: all 0.3s ease;
            width: 100%;
            box-sizing: border-box;
            box-shadow:
                0 2px 8px rgba(0, 0, 0, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }

        .form-control:focus {
            background: rgba(255, 255, 255, 0.95);
            border-color: var(--apple-blue);
            box-shadow:
                0 0 0 3px rgba(0, 122, 255, 0.15),
                0 4px 20px rgba(0, 122, 255, 0.2);
            color: #1d1d1f;
            outline: none;
        }

        .form-control::placeholder {
            color: var(--apple-label-tertiary);
            font-weight: 400;
        }

        #phone {
            padding-left: 65px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #007AFF 0%, #5AC8FA 100%);
            border: none;
            border-radius: 12px;
            padding: 16px 32px;
            font-weight: 600;
            font-size: 17px;
            color: #FFFFFF;
            letter-spacing: -0.01em;
            transition: all 0.3s ease;
            box-shadow:
                0 4px 16px rgba(0, 122, 255, 0.3),
                0 2px 4px rgba(0, 0, 0, 0.1);
            width: 100%;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #0056CC 0%, #4A9EE7 100%);
            transform: translateY(-2px);
            box-shadow:
                0 6px 20px rgba(0, 122, 255, 0.4),
                0 4px 8px rgba(0, 0, 0, 0.15);
            color: #FFFFFF;
        }

        .btn-primary:active {
            transform: translateY(0) scale(0.96);
            box-shadow:
                0 2px 8px rgba(0, 122, 255, 0.3),
                0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 16px 32px;
            font-weight: 600;
            font-size: 17px;
            color: var(--apple-blue);
            letter-spacing: -0.01em;
            transition: all 0.3s ease;
            box-shadow:
                0 2px 8px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            width: 100%;
            margin-top: 12px;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.95);
            transform: translateY(-2px);
            box-shadow:
                0 4px 12px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            color: #0056CC;
        }

        .divider {
            text-align: center;
            margin: 30px 0;
            position: relative;
            color: var(--apple-label-secondary);
            font-size: 14px;
        }

        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--apple-label-tertiary);
            z-index: 1;
        }

        .divider span {
            background: rgba(255, 255, 255, 0.9);
            padding: 0 16px;
            position: relative;
            z-index: 2;
        }

        .alert {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .alert-success {
            border-color: var(--apple-green);
            color: var(--apple-green);
        }

        .alert-danger {
            border-color: var(--apple-red);
            color: var(--apple-red);
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
        }

        .qr-container {
            text-align: center;
            padding: 20px;
        }

        #qr-code {
            margin: 20px auto;
            display: inline-block;
            min-height: 200px;
        }

        #qr-code.has-qr {
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .spinner-border {
            width: 1.5rem;
            height: 1.5rem;
            border-width: 2px;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="login-card">
            <h1 class="login-title">Message Downloader</h1>
            <p class="login-subtitle">è«‹ä½¿ç”¨ Telegram å¸³è™Ÿç™»å…¥</p>

            <div id="alert-container"></div>

            <!-- æ­¥é©Ÿ 2: é›»è©±è™Ÿç¢¼è¼¸å…¥ -->
            <div id="step-2" class="step active">
                <div class="phone-input-group">
                    <span class="country-code">+886</span>
                    <input type="text" id="phone" class="form-control" placeholder="9xxxxxxxx" pattern="[0-9]{9}" maxlength="9">
                </div>
                <button id="send-code-btn" class="btn btn-primary">
                    ç™¼é€é©—è­‰ç¢¼
                </button>
                <div class="divider">
                    <span>æˆ–</span>
                </div>
                <button id="qr-login-from-phone-btn" class="btn btn-secondary">
                    <i class="fas fa-qrcode me-2"></i>ä½¿ç”¨ QR Code ç™»å…¥
                </button>
            </div>

            <!-- æ­¥é©Ÿ 3: é©—è­‰ç¢¼è¼¸å…¥ -->
            <div id="step-3" class="step">
                <input type="text" id="verification-code" class="form-control mb-3" placeholder="è«‹è¼¸å…¥é©—è­‰ç¢¼" maxlength="5">
                <button id="verify-code-btn" class="btn btn-primary">
                    é©—è­‰
                </button>
                <button id="back-to-phone-btn" class="btn btn-secondary">
                    è¿”å›
                </button>
            </div>

            <!-- æ­¥é©Ÿ 4: å…©æ­¥é©Ÿé©—è­‰å¯†ç¢¼ -->
            <div id="step-4" class="step">
                <input type="password" id="two-factor-password" class="form-control mb-3" placeholder="è«‹è¼¸å…¥å…©æ­¥é©Ÿé©—è­‰å¯†ç¢¼">
                <button id="verify-password-btn" class="btn btn-primary">
                    é©—è­‰å¯†ç¢¼
                </button>
            </div>

            <!-- æ­¥é©Ÿ 5: QR Code ç™»å…¥ -->
            <div id="step-5" class="step">
                <div class="qr-container">
                    <h5 class="mb-3">æƒæ QR Code ç™»å…¥</h5>
                    <p class="text-muted mb-3">ä½¿ç”¨ Telegram æ‡‰ç”¨ç¨‹å¼æƒæä¸‹æ–¹ QR Code</p>
                    <div id="qr-code"></div>
                    <div id="qr-status" class="mt-3">
                        <div class="spinner-border text-primary me-2"></div>
                        æ­£åœ¨ç”Ÿæˆ QR Code...
                    </div>
                    <button id="refresh-qr-btn" class="btn btn-primary mt-3" style="display: none;">
                        <i class="fas fa-sync-alt me-2"></i>é‡æ–°ç”Ÿæˆ QR Code
                    </button>
                </div>
                <button id="back-to-method-from-qr-btn" class="btn btn-secondary">
                    è¿”å›é¸æ“‡ç™»å…¥æ–¹å¼
                </button>
            </div>

            <!-- æ­¥é©Ÿ 6: ç™»å…¥æˆåŠŸ -->
            <div id="step-6" class="step">
                <div class="text-center">
                    <i class="fas fa-check-circle text-success mb-3" style="font-size: 3rem;"></i>
                    <h5 class="mb-3">ç™»å…¥æˆåŠŸï¼</h5>
                    <p class="text-muted">æ­£åœ¨è·³è½‰åˆ° Message Downloader...</p>
                    <div class="spinner-border text-primary mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <script>
        let currentStep = 2;
        let sessionKey = '';
        let qrLoginInterval = null;

        function showStep(step) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById(`step-${step}`).classList.add('active');
            currentStep = step;
        }

        function showAlert(message, type = 'danger') {
            const alertContainer = document.getElementById('alert-container');
            alertContainer.innerHTML = `
                <div class="alert alert-${type}">
                    ${message}
                </div>
            `;
            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 5000);
        }

        // QR Code ç™»å…¥æŒ‰éˆ•
        document.getElementById('qr-login-from-phone-btn').addEventListener('click', () => {
            showStep(5);
            startQRLogin();
        });

        // QR Code åˆ·æ–°æŒ‰éˆ•
        document.getElementById('refresh-qr-btn').addEventListener('click', () => {
            // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
            document.getElementById('qr-status').innerHTML = '<div class="spinner-border text-primary me-2"></div>æ­£åœ¨é‡æ–°ç”Ÿæˆ QR Code...';
            document.getElementById('refresh-qr-btn').style.display = 'none';

            // æ¸…é™¤èˆŠçš„ QR Code
            const qrContainer = document.getElementById('qr-code');
            qrContainer.innerHTML = '';
            qrContainer.classList.remove('has-qr');

            // é‡æ–°é–‹å§‹ QR ç™»å…¥
            startQRLogin();
        });

        document.getElementById('back-to-method-from-qr-btn').addEventListener('click', () => {
            if (qrLoginInterval) {
                clearInterval(qrLoginInterval);
                qrLoginInterval = null;
            }
            showStep(2);
        });

        document.getElementById('back-to-phone-btn').addEventListener('click', () => {
            showStep(2);
        });

        // é›»è©±è™Ÿç¢¼è¼¸å…¥è™•ç†
        document.getElementById('phone').addEventListener('input', function(e) {
            // åªå…è¨±æ•¸å­—
            this.value = this.value.replace(/[^0-9]/g, '');

            // é™åˆ¶é•·åº¦ç‚º9ä½æ•¸
            if (this.value.length > 9) {
                this.value = this.value.slice(0, 9);
            }
        });

        // ç™¼é€é©—è­‰ç¢¼
        document.getElementById('send-code-btn').addEventListener('click', async () => {
            const phone = document.getElementById('phone').value;
            const sendButton = document.getElementById('send-code-btn');

            if (!phone || phone.length !== 9) {
                showAlert('è«‹è¼¸å…¥æ­£ç¢ºçš„é›»è©±è™Ÿç¢¼ï¼ˆ9ä½æ•¸å­—ï¼‰');
                return;
            }

            const fullPhone = '+886' + phone;

            // é˜²æ­¢é‡è¤‡æäº¤
            if (sendButton.disabled) {
                return;
            }

            // ç¦ç”¨æŒ‰éˆ•ä¸¦é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            sendButton.disabled = true;
            const originalText = sendButton.innerHTML;
            sendButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ç™¼é€ä¸­...';

            try {
                const response = await fetch('/api/auth/send_code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        phone_number: fullPhone
                    })
                });

                const result = await response.json();

                if (result.success) {
                    sessionKey = result.session_key;
                    showStep(3);
                    showAlert('é©—è­‰ç¢¼å·²ç™¼é€åˆ°æ‚¨çš„ Telegram', 'success');
                } else {
                    showAlert(result.error || 'ç™¼é€é©—è­‰ç¢¼å¤±æ•—');
                }
            } catch (error) {
                showAlert('ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
            } finally {
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                sendButton.disabled = false;
                sendButton.innerHTML = originalText;
            }
        });

        // é©—è­‰é©—è­‰ç¢¼
        document.getElementById('verify-code-btn').addEventListener('click', async () => {
            const code = document.getElementById('verification-code').value;
            const verifyButton = document.getElementById('verify-code-btn');

            if (!code) {
                showAlert('è«‹è¼¸å…¥é©—è­‰ç¢¼');
                return;
            }

            // é˜²æ­¢é‡è¤‡æäº¤
            if (verifyButton.disabled) {
                return;
            }

            // ç¦ç”¨æŒ‰éˆ•ä¸¦é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            verifyButton.disabled = true;
            const originalText = verifyButton.innerHTML;
            verifyButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>é©—è­‰ä¸­...';

            try {
                const response = await fetch('/api/auth/verify_code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_key: sessionKey,
                        verification_code: code
                    })
                });

                const result = await response.json();

                if (result.success) {
                    if (result.requires_password) {
                        showStep(4);
                        showAlert('è«‹è¼¸å…¥å…©æ­¥é©Ÿé©—è­‰å¯†ç¢¼', 'success');
                    } else {
                        // ç™»å…¥æˆåŠŸ
                        showStep(6);
                        setTimeout(() => {
                            window.location.href = '/message_downloader';
                        }, 2000);
                    }
                } else {
                    showAlert(result.error || 'é©—è­‰ç¢¼éŒ¯èª¤');
                }
            } catch (error) {
                showAlert('ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
            } finally {
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                verifyButton.disabled = false;
                verifyButton.innerHTML = originalText;
            }
        });

        // é©—è­‰å…©æ­¥é©Ÿå¯†ç¢¼
        document.getElementById('verify-password-btn').addEventListener('click', async () => {
            const password = document.getElementById('two-factor-password').value;
            const passwordButton = document.getElementById('verify-password-btn');

            if (!password) {
                showAlert('è«‹è¼¸å…¥å…©æ­¥é©Ÿé©—è­‰å¯†ç¢¼');
                return;
            }

            // é˜²æ­¢é‡è¤‡æäº¤
            if (passwordButton.disabled) {
                return;
            }

            // ç¦ç”¨æŒ‰éˆ•ä¸¦é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            passwordButton.disabled = true;
            const originalText = passwordButton.innerHTML;
            passwordButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>é©—è­‰ä¸­...';

            try {
                const response = await fetch('/api/auth/verify_password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_key: sessionKey,
                        password: password
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // ç™»å…¥æˆåŠŸ
                    showStep(6);
                    setTimeout(() => {
                        window.location.href = '/message_downloader';
                    }, 2000);
                } else {
                    showAlert(result.error || 'å¯†ç¢¼éŒ¯èª¤');
                }
            } catch (error) {
                showAlert('ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
            } finally {
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                passwordButton.disabled = false;
                passwordButton.innerHTML = originalText;
            }
        });

        // QR Code ç™»å…¥
        async function startQRLogin() {
            try {
                const response = await fetch('/api/auth/qr_login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();

                if (result.success) {
                    sessionKey = result.session_key;

                    // ç”Ÿæˆ QR Code
                    const qrContainer = document.getElementById('qr-code');
                    qrContainer.innerHTML = '';
                    qrContainer.classList.add('has-qr');

                    // ä½¿ç”¨ qrcode-generator åº«
                    const qr = qrcode(0, 'M');
                    qr.addData(result.qr_token);
                    qr.make();

                    const qrImg = document.createElement('img');
                    qrImg.src = qr.createDataURL(4, 2);
                    qrImg.style.width = '200px';
                    qrImg.style.height = '200px';
                    qrContainer.appendChild(qrImg);

                    document.getElementById('qr-status').innerHTML = 'è«‹ä½¿ç”¨ Telegram æƒæ QR Code';
                    document.getElementById('refresh-qr-btn').style.display = 'none';

                    // é–‹å§‹è¼ªè©¢ç™»å…¥ç‹€æ…‹
                    qrLoginInterval = setInterval(checkQRLoginStatus, 2000);
                } else {
                    showAlert(result.error || 'ç„¡æ³•ç”Ÿæˆ QR Code');
                }
            } catch (error) {
                showAlert('ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        async function checkQRLoginStatus() {
            try {
                console.log('Checking QR login status...', sessionKey);
                const response = await fetch('/api/auth/check_qr_status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_key: sessionKey
                    })
                });

                const result = await response.json();
                console.log('QR status result:', result);

                if (result.success && result.authenticated) {
                    console.log('ğŸ‰ QR login authenticated! Redirecting...');
                    clearInterval(qrLoginInterval);
                    showStep(6);
                    setTimeout(() => {
                        window.location.href = '/message_downloader';
                    }, 2000);
                } else if (result.expired) {
                    clearInterval(qrLoginInterval);
                    showAlert('QR Code å·²éæœŸï¼Œè«‹é‡æ–°ç”Ÿæˆ');
                    document.getElementById('qr-status').innerHTML = 'QR Code å·²éæœŸ';
                    document.getElementById('refresh-qr-btn').style.display = 'inline-block';
                    // æ¸…é™¤ QR Code å®¹å™¨
                    const qrContainer = document.getElementById('qr-code');
                    qrContainer.innerHTML = '';
                    qrContainer.classList.remove('has-qr');
                }
            } catch (error) {
                console.error('æª¢æŸ¥ QR ç™»å…¥ç‹€æ…‹å¤±æ•—:', error);
            }
        }

        // Enter éµè™•ç†
        document.getElementById('phone').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('send-code-btn').click();
            }
        });

        document.getElementById('verification-code').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('verify-code-btn').click();
            }
        });

        document.getElementById('two-factor-password').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('verify-password-btn').click();
            }
        });
    </script>
</body>
</html>